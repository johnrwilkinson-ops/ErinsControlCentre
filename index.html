
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Erin's Control Centre ‚Äî Builder (v3.5-large)</title>
<meta name="theme-color" content="#0e111a">
<style>
:root{ --bg:#0b1020; --panel:#101733; --text:#e9ecf4; --muted:#aab1bf; --accent:#7aa2f7; --line:#222844; --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.35); }
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
body{ margin:0; color:var(--text); background: radial-gradient(1800px 900px at 50% -200px,#141a33,var(--bg)); font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial; }
header{ position:sticky; top:0; z-index:40; padding:14px 18px; border-bottom:1px solid var(--line); backdrop-filter: blur(8px); background:linear-gradient(180deg,rgba(16,21,40,.92),rgba(12,16,32,.9)); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
h1{margin:0; font-size:20px; letter-spacing:.3px}
.container{display:grid; grid-template-columns: 1fr 1fr; gap:16px; padding:16px; max-width:1200px; margin:0 auto}
.full{ grid-column: 1 / -1 }
.card{ background:linear-gradient(180deg,#121a33,#0f1426); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow:var(--shadow); }
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
button, input[type="number"], input[type="text"], input[type="file"]{ border-radius:14px; padding:12px 14px; border:1px solid #26305a; background:#121735; color:var(--text); min-height:44px; font-size:15px; }
button{cursor:pointer}
button.primary{ background:linear-gradient(180deg,#22316b,#1c2755); border-color:#2a3777 }
.badge{font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid #2b355f; background:#172046}
.canvasWrap{display:flex; justify-content:center; align-items:center}
/* LARGE, RESPONSIVE WHEEL */
#wheel{ width:100%; max-width:780px; aspect-ratio:1/1; background:#0b0f1a; border-radius:50%; border:1px solid #22283f}
@media (max-width: 860px){ #wheel{ max-width: 96vw; } }
@media (max-width: 860px){ #wheel{ max-width:95vw; } }
#d10{ width:120px; height:120px; border-radius:16px; border:1px solid #253055; background: radial-gradient(320px 160px at 50% -30px,#162037,#0f1422); display:flex; align-items:center; justify-content:center; font-size:44px; font-weight:900}
pre.out{white-space:pre-wrap; background:#0e121d; border:1px solid var(--line); border-radius:14px; padding:10px; max-height:280px; overflow:auto; font-size:13px }
.log{max-height:220px; overflow:auto; font-size:12px; background:#0e121d; border:1px solid var(--line); border-radius:14px; padding:8px}
.slot{ border:1px solid #1e2548; border-radius:14px; padding:10px; background:#0f1430 }
.slot h4{ margin:0 0 6px 0; font-size:14px }
.slot .value{ min-height:22px; font-weight:700; font-size:14px }
.advanced{display:none;margin-top:10px}
@media (max-width: 860px){
  .container{grid-template-columns:1fr}
  h1{font-size:18px}
}

/* Stacked Session Builder rows */
.sb-list{ display:flex; flex-direction:column; gap:10px }
.sb-row{ display:grid; grid-template-columns: 36px 1fr auto auto; gap:10px; align-items:center; background:#0f1430; border:1px solid #1e2548; border-radius:14px; padding:10px 12px }
.sb-row .icon{ font-size:20px; text-align:center }
.sb-row .label{ font-weight:700 }
.sb-row .value{ color:#cbd5e1; min-height:22px }
.sb-row .spin{ padding:8px 12px; border-radius:12px; border:1px solid #26305a; background:#121735; color:#e9ecf4; cursor:pointer }
@media (max-width:700px){
  .sb-row{ grid-template-columns: 30px 1fr; grid-template-rows: auto auto; }
  .sb-row .value{ grid-column: 2 / -1 }
  .sb-row .spin{ grid-column: 2 / -1; justify-self:start }
}


/* Larger, clock-like timer readouts */
.badge.clock{ font-size:32px; font-weight:900; letter-spacing:.8px; padding:12px 18px; }
.badge.clock.running{ box-shadow: 0 0 0 0 rgba(122,162,247,.45); animation: pulse 1.8s ease-out infinite; }
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(122,162,247,.45) }
  70%{ box-shadow:0 0 0 14px rgba(122,162,247,0) }
  100%{ box-shadow:0 0 0 0 rgba(122,162,247,0) }
}
.badge.wide-badge{ max-width:100%; white-space:normal }
</style>






</head>
<body>
<header>
  <h1>Erin‚Äôs Control Centre ‚Äî Builder</h1>
  <div class="row">
    <a class="badge" href="companion_v3_5.html" target="_blank">Open Companion</a>
    <label class="badge">Room <input id="roomId" type="text" value="main" style="min-height:auto;padding:.3rem .5rem"></label>
    <button id="btnLockNow" class="ghost">Lock</button>
    <button id="btnPanic" class="ghost">Panic</button>
    <button id="advToggle" class="ghost" data-open="0">Advanced</button>
  </div>
</header>

<!-- PASSCODE OVERLAY -->
<div id="lockOverlay" style="position:fixed;inset:0;background:#0a0e1d;display:flex;align-items:center;justify-content:center;z-index:9999;">
  <div style="width:min(92vw,420px);background:linear-gradient(180deg,#121a33,#0f1426);border:1px solid #24305a;border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.35);">
    <h2 style="margin:0 0 8px;font:600 18px system-ui;color:#e9ecf4">Enter Passcode</h2>
    <p style="margin:0 0 12px;color:#aab1bf;font:14px system-ui">Set a new passcode the first time; after that it will unlock with the same code.</p>
    <input id="lockInput" type="password" inputmode="numeric" placeholder="4‚Äì8 digits" minlength="4" maxlength="8"
           style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid #26305a;background:#121735;color:#e9ecf4">
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="lockSubmit" style="flex:1;padding:12px 14px;border-radius:12px;border:1px solid #2a3777;background:linear-gradient(180deg,#22316b,#1c2755);color:#e9ecf4">Unlock</button>
      <button id="panicHide" style="padding:12px 14px;border-radius:12px;border:1px solid #6d2a38;background:#3a1c25;color:#ffd7dc">Panic</button>
    </div>
    <div id="lockMsg" style="margin-top:10px;color:#fda4af;font:13px system-ui"></div>
<div style="margin-top:8px;text-align:center;"><button id="forgotCode" style="background:none;border:none;color:#9ab7ff;text-decoration:underline;cursor:pointer">Forgot code? Reset lock</button></div>
  </div>
</div>

<div class="container">
  
  <!-- Wheel -->
  <section class="card full">
    <h2>Length / Result Wheel</h2>
    <div class="canvasWrap" style="justify-content:center; align-items:center; width:100%; margin:6px 0 10px">
      <div style="width:100%; max-width:780px;">
        <canvas id="wheel" width="640" height="640"></canvas>
      </div>
    </div>
    <div class="row" style="justify-content:center; gap:12px">
      <button id="spinWheel" class="primary">Spin 12s Wheel</button>
      <span class="badge" id="wheelBadge">‚Äî</span>
    </div>
  </section>

  <!-- Session Builder -->

<section class="card full">
  <h2>Session Builder</h2>
  <div class="row">
    <button id="spinBuilder" class="primary">Spin Session Builder</button>
    <span class="badge" id="builderBadge">Ready</span>
  </div>

  <div class="sb-list" style="margin-top:10px">
    <div class="sb-row" data-key="difficulty"><span class="icon">üè∑Ô∏è</span><span class="label">Difficulty</span><span class="value" id="val-difficulty">‚Äî</span><button class="spin" data-spin="difficulty">Spin</button></div>
    <div class="sb-row" data-key="scenario"><span class="icon">üé≠</span><span class="label">Scenario / Clothing</span><span class="value" id="val-scenario">‚Äî</span><button class="spin" data-spin="scenario">Spin</button></div>
    <div class="sb-row" data-key="hoods"><span class="icon">üßï</span><span class="label">Hoods</span><span class="value" id="val-hoods">‚Äî</span><button class="spin" data-spin="hoods">Spin</button></div>
    <div class="sb-row" data-key="gags"><span class="icon">ü§ê</span><span class="label">Gags</span><span class="value" id="val-gags">‚Äî</span><button class="spin" data-spin="gags">Spin</button></div>
    <div class="sb-row" data-key="extras"><span class="icon">‚ûï</span><span class="label">Extras</span><span class="value" id="val-extras">‚Äî</span><button class="spin" data-spin="extras">Spin</button></div>
    <div class="sb-row" data-key="anal"><span class="icon">üçë</span><span class="label">Anal</span><span class="value" id="val-anal">‚Äî</span><button class="spin" data-spin="anal">Spin</button></div>
    <div class="sb-row" data-key="fm"><span class="icon">‚öôÔ∏è</span><span class="label">Fucking Machine</span><span class="value" id="val-fm">‚Äî</span><button class="spin" data-spin="fm">Spin</button></div>
    <div class="sb-row" data-key="location"><span class="icon">üìç</span><span class="label">Location</span><span class="value" id="val-location">‚Äî</span><button class="spin" data-spin="location">Spin</button></div>
    <div class="sb-row" data-key="position"><span class="icon">üßò</span><span class="label">Position</span><span class="value" id="val-position">‚Äî</span><button class="spin" data-spin="position">Spin</button></div>
    <div class="sb-row" data-key="wand"><span class="icon">üîå</span><span class="label">Vibrating Wand</span><span class="value" id="val-wand">‚Äî</span><button class="spin" data-spin="wand">Spin</button></div>
    <div class="sb-row" data-key="audio"><span class="icon">üéß</span><span class="label">Audio</span><span class="value" id="val-audio">‚Äî</span><button class="spin" data-spin="audio">Spin</button></div>
    <div class="sb-row" data-key="restriction"><span class="icon">‚õìÔ∏è</span><span class="label">Restriction (‚â•2)</span><span class="value" id="val-restriction">‚Äî</span><button class="spin" data-spin="restriction">Spin</button></div>
    <div class="sb-row" data-key="nipples"><span class="icon">üìé</span><span class="label">Nipples</span><span class="value" id="val-nipples">‚Äî</span><button class="spin" data-spin="nipples">Spin</button></div>
    <div class="sb-row" data-key="estim"><span class="icon">‚ö°</span><span class="label">E-Stim</span><span class="value" id="val-estim">‚Äî</span><button class="spin" data-spin="estim">Spin</button></div>
    <div class="sb-row" data-key="collar"><span class="icon">üìø</span><span class="label">Collar</span><span class="value" id="val-collar">‚Äî</span><button class="spin" data-spin="collar">Spin</button></div>
  </div>
</section>

<!-- Timer -->

  <section class="card full">
    <h2>Timer</h2>
    <div class="row">
      <label>Prep (mins) <input type="number" id="prepMins" value="20" min="0" step="1"></label>
      <label>Session (mins) <input type="number" id="sessMins" placeholder="From wheel" min="1" step="1"></label>
      <span class="badge" id="prepFace" class="badge clock">Prep: 00:00</span>
      <span class="badge" id="sessFace" class="badge clock">Session: 00:00</span>
    </div>
    <div class="row">
      <button id="startPrepSession" class="primary">Start Prep+Session</button>
      <button id="startSessionOnly">Start Session</button>
      <button id="pauseTimer">Pause</button>
      <button id="resumeTimer">Resume</button>
      <button id="resetTimer" style="background:#3a1c25;border-color:#6d2a38;color:#ffd7dc">Reset</button>
    </div>
    <div class="row" style="justify-content:center; gap:18px; margin-top:10px">
      <span id="prepFace" class="badge clock">Prep: 00:00</span>
      <span id="sessFace" class="badge clock">Session: 00:00</span>
    </div>
  </section>

  <!-- Dice -->
  <section class="card full">
    <h2>Dice (d10)</h2>
    <div class="row" style="align-items:center">
      <div id="d10">‚Äî</div>
      <button id="rollD10" class="primary">Roll d10</button>
      <span class="badge">‚ÄúX‚Äù auto-updates</span>
    </div>
  </section>

  
  <!-- End of Session -->
  <section class="card full">
    <h2>End of Session</h2>
    <div class="row" style="flex-direction:column; align-items:flex-start; gap:12px">
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <button id="spinPun" class="primary" style="background:#7c2d12;border-color:#7c2d12">Spin Punishment</button>
        <span class="badge wide-badge" id="val-punishment">‚Äî</span>
      </div>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <button id="spinRew" class="primary" style="background:#065f46;border-color:#065f46">Spin Reward</button>
        <span class="badge wide-badge" id="val-reward">‚Äî</span>
      </div>
      <div class="row" style="gap:10px; flex-wrap:wrap">
        <button id="shareSnapshot">Share Snapshot Link</button>
        <span class="badge">Companion live sync is enabled; snapshot also available.</span>
      </div>
    </div>
  </section>


  <section class="card full">
    <h2>Summary</h2>
    <pre class="out" id="summary">‚Äî</pre>
    <h2>Log</h2><div class="log" id="log"></div>
    <div class="row" style="margin-top:8px">
      <button id="copySummary">Copy</button>
      <button id="exportJson">Export Session</button>
      <label><input type="file" id="importJson" accept="application/json"> Import</label>
      <button id="exportLog">Export Log</button>
    </div>
  </section>
</div>

<script>

// ---- Unlock helpers (added) ----
function resetLockStorage() {
  try {
    localStorage.removeItem("ecc_pass_hash_v1");
    localStorage.removeItem("ecc_locked_v1");
    return true;
  } catch(e) { return false; }
}
// Allow reset via URL: ?reset=1 or #reset
(function(){
  if (/[#?].*(reset=1|#reset)/.test(location.href)) {
    resetLockStorage();
  }
})();

// ===== Utils & RNG =====
function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179)}h1=(h3^(h1>>>18))>>>0;h2=(h4^(h2>>>22))>>>0;h3=(h1^(h3>>>17))>>>0;h4=(h2^(h4>>>19))>>>0;return[h1,h2,h3,h4]}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
function seededRand(seedStr){const s=cyrb128(seedStr||"echo");return mulberry32(s[0])}
var rng=Math.random;
function updateRNG(){ var adv=document.getElementById('advToggle'); var advOpen = adv && adv.dataset.open==="1"; if(!advOpen){ rng=Math.random; return; } var seedToggleEl=document.getElementById('seedToggle'); var seedValEl=document.getElementById('seedValue'); var useSeed = seedToggleEl ? seedToggleEl.checked : false; var seedVal = seedValEl && seedValEl.value ? (''+seedValEl.value).trim() : ''; rng = (useSeed && seedVal) ? seededRand(seedVal) : Math.random; }
function pickUniform(list){ return list[Math.floor(rng()*list.length)] }
function chooseN(list, n){ var a=list.slice(); var res=[]; while(res.length<n && a.length){ var i=Math.floor(rng()*a.length); res.push(a.splice(i,1)[0]); } return res; }
function log(msg){ var el=document.getElementById('log'); if(!el) return; var div=document.createElement('div'); div.textContent=new Date().toLocaleString()+" ‚Äî "+msg; el.prepend(div); }
function shuffle(arr){ var a=arr.slice(); for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
function b64url(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'') }
function fromB64url(s){ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='='; return JSON.parse(decodeURIComponent(escape(atob(s)))) }

// ===== High-DPI responsive canvas sizing =====
function resizeWheelCanvas(){
  var canvas = document.getElementById('wheel');
  if(!canvas) return;
  var dpr = window.devicePixelRatio || 1;
  var rect = canvas.getBoundingClientRect();
  var size = Math.min(rect.width || 0, rect.height || rect.width || 0);
  var px = Math.max(200, Math.floor(size * dpr));
  if(canvas.width !== px || canvas.height !== px){
    canvas.width = px;
    canvas.height = px;
    drawWheel(canvas, CURRENT_WHEEL || DATA.mergedWheel, wheelRot || 0);
  }
}
window.addEventListener('resize', resizeWheelCanvas);

// ===== Icons & Data =====
var ICON_LOC = {"Bed":"üõè","Floor":"üß±","Bathroom":"üõÅ","Shed":"üõñ","Gym":"üèãÔ∏è","Living":"üõã","Couch":"üõã","Table":"üçΩ","Sauna":"üßñ","Van":"üöê"};
function locIcon(t){ return ICON_LOC[t] ? ICON_LOC[t]+" "+t : t }
var DATA = {
  mergedWheel:[{label:"20 mins",weight:5},{label:"30 mins",weight:15},{label:"40 mins",weight:20},{label:"50 mins",weight:10},{label:"60 mins",weight:10},{label:"90 mins",weight:10},{label:"120 mins",weight:5},{label:"150 mins",weight:3},{label:"180 mins",weight:2},{label:"Re-roll & Double",weight:5},{label:"-1 day & Re-roll",weight:5},{label:"+1 day & Re-roll",weight:5},{label:"Erin‚Äôs Choice",weight:5}],
  scenario:["My Choice","None/Naked","Bondage","Prisoner/Interrogation","Objectification (furniture/decoration)","Maid Service","Feminisation ‚Äì Fishnets, Panties, Bra, Makeup","Service","Fully Clothed","Shirt Only","Cop Uniform","Fire Uniform","Latex"],
  difficulty:["My Choice","Light","Moderate","Harsh","Extreme"],
  gags:["My Choice","None","Inflatable gag","Jennings","Tape","Dirty Panties in Mouth and tape","Ball gag",{label:"Deepthroat and suck a dildo",requires:function(ctx){return (['None','My Choice','Blindfold'].indexOf(ctx.hoodCompat||'None')!==-1)}}, "Ring gag","Bit gag",{label:"Dildo gag",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=30)}}],
  hoods:["My Choice","None","Blindfold","Latex",{label:"Latex Inflatable",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=20)}}, "Skull","Material","Pantyhose",{label:"Sensory Deprivation",requires:function(ctx){return true}}],
  extras:["My Choice","None","Body Sack","Spreader bar","Cockring","Medical Gloves"],
  anal:["My Choice","None","S Plug","M Plug",{label:"L Plug",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=30)}},{label:"XL Plug",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=20)}}, "Hook"],
  fm:["My Choice",{label:"Yes",requires:function(ctx){return ctx.lengthMins<=30}},"No"],
  location:["My Choice","Bed","Floor","Bathroom","Shed","Gym","Living","Couch","Table","Sauna","Van"],
  position:["My Choice","Spreadeagle","Wrists to ankles","Frog tie",{label:"Hog tie",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=30)}}, "Kneeling",{label:"Fully Suspended",requires:function(ctx){return (['Harsh','Extreme'].indexOf(ctx.difficulty)!==-1 && ctx.lengthMins<=30)}}, "Partial Suspension","Sitting","Standing","All Fours","On a Chair"],
  wand:["My Choice","Yes","No"],
  audio:["My Choice","None","Music","Sissy Hypno","Submissive Hypno","BDSM Video","Sex Video","Humiliation","White Noise"],
  restriction:["My Choice","Handcuffs","Straps","Chain","Rope","Tape","Cable Ties"],
  nipples:["My Choice","None","Clover Clamps","Clothespins","Bulldog Clips","Cupping","String","Pincer Clamps","Clamp Clotheshanger","Chopsticks"],
  estim:["My Choice","None","Nipples","Anal","Roger","Balls","Ears"],
  collar:["My Choice","None","Leather","Chain","Rope","Posture"],
  punishment:["Erin‚Äôs Choice","None","X day/s added to chastity period","Next time you cum you must eat it all","Self spanking ‚Äî 1 spank for every minute that was remaining on timer","Wear spiked chastity tip for X mins","Ginger anal plug for X mins","Deep heat on nipples","Complete all household chores in Bondage while Erin is at Tennis, including toilets and showers","Wear panties 24/7 till next session","Spin 2 more times for a total of 2 punishments","Insert Medium to Large plug for X hours"],
  reward:["Erin‚Äôs Choice","None","Edge self X times while Erin watches, no cumming (if you cum, 1 week added to chastity period)","Edge self X times, then cum","‚ÄúSurprise Unlock‚Äù: hands cuffed, Edged X times by Erin with Wand or Hands, no cumming (if you cum, 1 week added to chastity period)","Allowed to sleep overnight in light bondage (in the spare room)","Complete all household chores in Bondage while Erin is at Tennis","Wear panties 24/7 till next session","Removal of cage for X hours but hands cuffed behind back","Naked bedtime cuddles with Erin, hands cuffed above or behind to restrict touching","Ruined Orgasm after X times edging","Spin 2 more times for a total of 2 rewards"]
};

// ===== State =====
var STATE = { lengthLabel:null, lengthMins:null, difficulty:null, picks:{}, d10:null, notes:[], timers:{prep:0,session:0,which:null,end:null} };
function ctx(){ return { difficulty:(STATE.difficulty&&STATE.difficulty!=='My Choice')?STATE.difficulty:'Moderate', lengthMins:(STATE.lengthMins!=null?STATE.lengthMins:40), hoodCompat:STATE.picks.hoods||'None' } }

// ===== Wheel =====
var CURRENT_WHEEL=null, wheelRot=0;
function initWheelOrder(){ CURRENT_WHEEL = shuffle(DATA.mergedWheel); }
function drawWheel(canvas, items, rotation){
  var ctx2 = canvas.getContext('2d'); var W=canvas.width, H=canvas.height, cx=W/2, cy=H/2;
  var radius=Math.min(W,H)/2-10; ctx2.clearRect(0,0,W,H);
  var total=items.reduce(function(a,b){return a+(b.weight||1)},0); var start=rotation%(Math.PI*2);
  var colors=["#7aa2f7","#f7768e","#9ece6a","#e0af68","#bb9af7","#73daca","#f6c177","#c0caf5","#89ddff","#ffd580","#a3e635","#fca5a5","#93c5fd","#d8b4fe"];
  items.forEach(function(o,i){
    var slice=(o.weight||1)/total*Math.PI*2; var end=start+slice;
    ctx2.beginPath(); ctx2.moveTo(cx,cy); ctx2.arc(cx,cy,radius,start,end); ctx2.closePath();
    ctx2.fillStyle=colors[i%colors.length]; ctx2.fill();
    if(slice>0.06){ ctx2.save(); ctx2.translate(cx,cy); ctx2.rotate(start+slice/2); ctx2.textAlign="right"; ctx2.fillStyle="#0b0f1a"; ctx2.font="bold 16px system-ui,-apple-system,Segoe UI,Roboto,Arial"; ctx2.fillText(o.label, radius-14, 6); ctx2.restore(); }
    start=end;
  });
  ctx2.beginPath(); ctx2.arc(cx,cy,40,0,Math.PI*2); ctx2.fillStyle="#101425"; ctx2.fill(); ctx2.lineWidth=3; ctx2.strokeStyle="#2a3460"; ctx2.stroke();
  var tipY = cy - radius - 6, baseY = tipY + 24, halfBase = 18;
  ctx2.beginPath(); ctx2.moveTo(cx, tipY); ctx2.lineTo(cx - halfBase, baseY); ctx2.lineTo(cx + halfBase, baseY); ctx2.closePath(); ctx2.fillStyle="#7aa2f7"; ctx2.fill();
}
function spinMergedWheel(canvas, durationMs){
  updateRNG(); if(!durationMs) durationMs=12000;
  var items = CURRENT_WHEEL || DATA.mergedWheel;
  var total=items.reduce(function(a,b){return a+(b.weight||1)},0); var r=rng()*total, idx=0, acc=0;
  for(var i=0;i<items.length;i++){ acc += items[i].weight||1; if(r<=acc){ idx=i; break; } }
  var start=0; for(var j=0;j<idx;j++){ start += items[j].weight||1 }
  var slice=((items[idx].weight||1)/total)*Math.PI*2; var targetMid=(start/total)*Math.PI*2 + slice/2;
  var startRot = wheelRot; var extra=(6+Math.floor(rng()*4))*Math.PI*2; var finalRot = (-Math.PI/2) - targetMid + extra; var delta = finalRot - startRot;
  var t0=performance.now();
  function ease(t){ return 1 - Math.pow(1 - t, 3); }
  return new Promise(function(resolve){
    function anim(now){ var t=Math.min(1,(now-t0)/durationMs); wheelRot = startRot + delta*ease(t); drawWheel(canvas, items, wheelRot); if(t<1){ requestAnimationFrame(anim)} else { resolve(idx) } }
    requestAnimationFrame(anim);
  });
}

// ===== Categories & spins =====
function validItems(arr, C){ return arr.map(function(v){ return (typeof v==='string')? {label:v} : v; }).filter(function(item){ if(!item.requires) return true; try{ return !!item.requires(C) }catch(_){ return false } }); }
function spinCategory(key){
  updateRNG(); var C=ctx(); var list=DATA[key]; if(!list) return "‚Äî";
  var candidates=validItems(list,C);
  if(key==='restriction'){
    var base=candidates.map(function(x){return x.label||x}).filter(function(x){return x!=='My Choice'});
    var nMax=Math.min(4,base.length); var n=Math.max(2, Math.floor(2 + Math.random()*(nMax-2+1)));
    var chosen=chooseN(base,n); STATE.picks[key]=chosen.join(", "); return STATE.picks[key];
  }
  if(candidates.length===0){ STATE.picks[key]="My Choice"; return "My Choice"; }
  var choice=pickUniform(candidates); var label=(typeof choice==='string')?choice:choice.label;
  if(key==='location') label=locIcon(label);
  STATE.picks[key]=label;
  if(key==='hoods' && String(label).indexOf('Sensory Deprivation')===0 && STATE.picks.audio==='None'){
    var audioList = DATA.audio.filter(function(a){return a!=='None'}); STATE.picks.audio = pickUniform(audioList);
  }
  return label;
}

// ===== Dice & X replacement =====
function rollD10Visual(el, onDone){
  updateRNG(); var frames=0,total=60; var target=1+Math.floor(rng()*10);
  function step(){ frames++; var val=1+Math.floor(rng()*10); el.textContent=val; el.style.transform='rotate('+(frames*24)+'deg)';
    if(frames<total){ requestAnimationFrame(step) } else { el.textContent=target; el.style.transform='rotate(0deg)'; STATE.d10=target; log('d10 ‚Üí '+target); if(onDone) onDone(target); postStateDebounced(); } }
  requestAnimationFrame(step);
}
function resolveXInText(text, xVal){
  if(!text || !/X/.test(text)) return text;
  if(/X mins/.test(text) && /(spiked chastity tip|Ginger anal plug)/.test(text)){ var mins = xVal*10; return text.replace("X mins", String(mins)+" mins"); }
  if(/X hours/.test(text) && /(Medium to Large plug)/.test(text)){ return text.replace("X hours", String(xVal)+" hours"); }
  return text.replace(/X\b/g,String(xVal));
}
function applyXEverywhere(){ if(!STATE.d10) return; ['punishment','reward'].forEach(function(k){ if(STATE.picks[k]) STATE.picks[k]=resolveXInText(STATE.picks[k], STATE.d10); var el=document.getElementById('val-'+k); if(el) el.textContent=STATE.picks[k]||'‚Äî'; }); }

// ===== Summary & Export =====
function summarize(){
  var items = { "Length": STATE.lengthLabel||"‚Äî","Difficulty": STATE.difficulty||"‚Äî","Scenario/Clothing": STATE.picks.scenario||"‚Äî","Hoods": STATE.picks.hoods||"‚Äî","Gags": STATE.picks.gags||"‚Äî","Extras": STATE.picks.extras||"‚Äî","Anal": STATE.picks.anal||"‚Äî","Fucking Machine": STATE.picks.fm||"‚Äî","Location": STATE.picks.location||"‚Äî","Position": STATE.picks.position||"‚Äî","Vibrating Wand": STATE.picks.wand||"‚Äî","Audio": STATE.picks.audio||"‚Äî","Restriction": STATE.picks.restriction||"‚Äî","Nipples": STATE.picks.nipples||"‚Äî","E-Stim": STATE.picks.estim||"‚Äî","Collar": STATE.picks.collar||"‚Äî","Punishment": STATE.picks.punishment||"‚Äî","Reward": STATE.picks.reward||"‚Äî","d10 (X)": STATE.d10||"‚Äî"};
  var md="**Erin's Control Centre ‚Äî Session Summary**\n"; Object.keys(items).forEach(function(k){ md += "\n- "+k+": "+items[k] });
  var el=document.getElementById('summary'); if(el) el.textContent=md;
  postStateDebounced();
}
function exportSession(){ var payload={ timestamp:new Date().toISOString(), state: STATE }; var blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download="erins_control_centre_session.json"; a.click(); setTimeout(function(){URL.revokeObjectURL(url)},5000); }
function exportLog(){ var txt=(document.getElementById('log') && document.getElementById('log').innerText) || ""; var blob=new Blob([txt],{type:"text/plain"}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download="erins_control_centre_log.txt"; a.click(); setTimeout(function(){URL.revokeObjectURL(url)},5000); }
function importSession(file, onDone){ var r=new FileReader(); r.onload=function(){ try{ var obj=JSON.parse(r.result); if(obj.state){ for(var k in obj.state){ STATE[k]=obj.state[k]; } if(onDone) onDone(); summarize(); } }catch(err){ alert("Invalid JSON"); } }; r.readAsText(file); }
function shareSnapshotLink(){ var origin = location.origin + location.pathname.replace(/[^\/]+$/, ''); var url = origin + "companion_v3_5.html#state=" + b64url({ state: STATE }); navigator.clipboard.writeText(url).then(function(){ log("Snapshot link copied."); alert("Snapshot link copied to clipboard."); }); }

// ===== Netlify Functions Sync =====
function getRoom(){ var v=document.getElementById('roomId'); return (v && v.value || 'main').trim().toLowerCase().replace(/[^a-z0-9_-]/g,'_').slice(0,64) || 'main' }
let postTimer=null;
async function postState(){ try{ await fetch('/.netlify/functions/save-state', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ room:getRoom(), state: STATE }) }); }catch(e){ console.warn('save-state failed', e); } }
function postStateDebounced(){ clearTimeout(postTimer); postTimer=setTimeout(postState, 400); }

// ===== Lock & Advanced bindings =====
var LOCK_KEY="ecc_pass_hash_v1", LOCKED_FLAG="ecc_locked_v1";
async function sha256Hex(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest("SHA-256", enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
function showLockOverlay(show){ var o=document.getElementById("lockOverlay"); if(o) o.style.display = show ? "flex" : "none"; }
function panicHideNow(){ localStorage.setItem(LOCKED_FLAG, "1"); document.body.innerHTML = "<div style='position:fixed;inset:0;background:#0a0e1d'></div>"; }
async function tryUnlock(pin){ var msg=document.getElementById("lockMsg"); if(!pin||pin.length<4||pin.length>8){ msg.textContent="Enter 4‚Äì8 digits."; return false; } var hash=await sha256Hex(pin); var saved=localStorage.getItem(LOCK_KEY); if(!saved){ localStorage.setItem(LOCK_KEY, hash); localStorage.removeItem(LOCKED_FLAG); return true; } if(saved===hash){ localStorage.removeItem(LOCKED_FLAG); return true; } msg.textContent="Incorrect code."; return false; }
function bindLockUI_OLD(){ var inp=document.getElementById("lockInput"), ok=document.getElementById("lockSubmit"), panic=document.getElementById("panicHide"), btnLock=document.getElementById("btnLockNow"), btnPanic=document.getElementById("btnPanic"), forgot=document.getElementById("forgotCode"); ok&&ok.addEventListener("click", async function(){ var pin=(inp.value||"").trim(); var okd=await tryUnlock(pin); if(okd){ showLockOverlay(false); } }); inp&&inp.addEventListener("keydown", async function(e){ if(e.key==="Enter"){ var okd=await tryUnlock((inp.value||"").trim()); if(okd){ showLockOverlay(false); } } }); panic&&panic.addEventListener("click", panicHideNow); btnPanic&&btnPanic.addEventListener("click", panicHideNow); btnLock&&btnLock.addEventListener("click", function(){ localStorage.setItem(LOCKED_FLAG,"1"); showLockOverlay(true); var el=document.getElementById("lockInput"); if(el) el.focus(); });
forgot&&forgot.addEventListener('click', function(){ if(resetLockStorage()){ document.getElementById('lockMsg').textContent='Lock reset. Enter a NEW 4‚Äì8 digit code.'; showLockOverlay(true); var el=document.getElementById('lockInput'); if(el){ el.value=''; el.focus(); } } });
if(localStorage.getItem(LOCKED_FLAG)==="1") showLockOverlay(true); else showLockOverlay(false); }

// ===== Spins / Outcomes / Timers =====
function handleWheelOutcome(pick, canvas){
  if(pick==="Re-roll & Double"){
    document.getElementById('wheelBadge').textContent='Re-rolling‚Ä¶';
    spinMergedWheel(canvas, 12000).then(function(idx2){
      var p2=(CURRENT_WHEEL||DATA.mergedWheel)[idx2].label; log("Re-roll result ‚Üí "+p2);
      if(/\d+ mins/.test(p2)){ var m=parseInt(p2); STATE.lengthMins=m*2; STATE.lengthLabel=p2+" (doubled)"; document.getElementById('wheelBadge').textContent=STATE.lengthLabel; document.getElementById('sessMins').value=STATE.lengthMins; }
      else { handleWheelOutcome(p2, canvas); if(STATE.lengthMins){ STATE.lengthMins*=2; STATE.lengthLabel=STATE.lengthLabel+" (doubled)"; document.getElementById('wheelBadge').textContent=STATE.lengthLabel; document.getElementById('sessMins').value=STATE.lengthMins; } }
      summarize();
    });
    return;
  }
  if(pick==="-1 day & Re-roll" || pick==="+1 day & Re-roll"){
    document.getElementById('wheelBadge').textContent='Re-rolling‚Ä¶'; STATE.notes.push("Modifier: "+pick);
    spinMergedWheel(canvas, 12000).then(function(idx2){ var p2=(CURRENT_WHEEL||DATA.mergedWheel)[idx2].label; log("Re-roll result ‚Üí "+p2); handleWheelOutcome(p2, canvas); });
    return;
  }
  if(pick==="Erin‚Äôs Choice"){ STATE.lengthLabel="Erin‚Äôs Choice"; STATE.lengthMins=null; document.getElementById('sessMins').value=""; document.getElementById('wheelBadge').textContent="Erin‚Äôs Choice"; summarize(); return; }
  var mins=parseInt(pick); if(!isNaN(mins)){ STATE.lengthMins=mins; STATE.lengthLabel=pick; document.getElementById('sessMins').value=mins; summarize(); }
}
function spinOutcome(kind){
  var list = DATA[kind]; var choice = pickUniform(list);
  if(choice==="Erin‚Äôs Choice"){ STATE.picks[kind]="Erin‚Äôs Choice"; }
  else if(choice.indexOf("Spin 2 more times")===0){
    var pool=list.filter(function(x){return x!=="Erin‚Äôs Choice" && x.indexOf("Spin 2")!==0});
    var c1=pickUniform(pool), c2=pickUniform(pool.filter(function(x){return x!==c1}));
    STATE.picks[kind]=(kind==='punishment'?"üé≤ ":"üé∞ ")+c1+" + "+c2;
  } else { STATE.picks[kind]=choice; }
  if(STATE.d10) STATE.picks[kind]=STATE.picks[kind].replace(/X\b/g, String(STATE.d10)).replace("X mins", String(STATE.d10*10)+" mins").replace("X hours", String(STATE.d10)+" hours");
  document.getElementById('val-'+kind).textContent=STATE.picks[kind];
  log((kind==="punishment"?"Punishment":"Reward")+" ‚Üí "+STATE.picks[kind]); summarize();
}

function bindTimer(){
  var prepFace=document.getElementById('prepFace'), sessFace=document.getElementById('sessFace'); var timer=null;
  function setRunClasses(running){
    [prepFace,sessFace].forEach(function(el){ if(!el) return; if(running) el.classList.add('running'); else el.classList.remove('running'); });
  }

  var prepFace=document.getElementById('prepFace'), sessFace=document.getElementById('sessFace'); var timer=null;
  function fmt(ms){ var s=Math.max(0,Math.floor(ms/1000)); var m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return String(m).padStart(2,'0')+':'+ss }
  function update(){ prepFace.textContent='Prep: '+fmt(STATE.timers.prep); sessFace.textContent='Session: '+fmt(STATE.timers.session); postStateDebounced(); }
  
function startPhase(which){
    setRunClasses(true);

    clearInterval(timer); var now=Date.now(); var minutes=0;
    if(which==="prep"){ minutes=Math.max(0, parseInt(document.getElementById('prepMins').value)||0); STATE.timers.prep=minutes*60000; }
    else { minutes=Math.max(1, parseInt(document.getElementById('sessMins').value) || STATE.lengthMins || 40); document.getElementById('sessMins').value=minutes; STATE.timers.session=minutes*60000; }
    STATE.timers.which=which; STATE.timers.end=now+(which==="prep"? STATE.timers.prep:STATE.timers.session);
    timer=setInterval(function(){ var remain=Math.max(0, STATE.timers.end-Date.now()); if(which==="prep") STATE.timers.prep=remain; else STATE.timers.session=remain; update(); if(remain<=0){ clearInterval(timer); if(which==="prep"){ log("Prep finished ‚Üí Session start"); startPhase("session"); } else { log("Session finished"); } } }, 300);
  }
  document.getElementById('startPrepSession').addEventListener('click', function(){ startPhase("prep") });
  document.getElementById('startSessionOnly').addEventListener('click', function(){ startPhase("session") });
  document.getElementById('pauseTimer').addEventListener('click', function(){ if(timer){ clearInterval(timer); timer=null; setRunClasses(false);} });
  document.getElementById('resumeTimer').addEventListener('click', function(){ if(!STATE.timers.which) return; var remain = STATE.timers.which==="prep"? STATE.timers.prep:STATE.timers.session; STATE.timers.end = Date.now() + remain; var which=STATE.timers.which; startPhase(which); });
  document.getElementById('resetTimer').addEventListener('click', function(){ clearInterval(timer); timer=null; STATE.timers={prep:0,session:0,which:null,end:null}; setRunClasses(false); update(); });
}

// ===== Init =====
function init(){
  initWheelOrder();
  var wheelCanvas=document.getElementById('wheel'); resizeWheelCanvas(); drawWheel(wheelCanvas, CURRENT_WHEEL, 0);
  document.getElementById('spinWheel').addEventListener('click', function(){ spinMergedWheel(wheelCanvas, 12000).then(function(idx){ var pick=(CURRENT_WHEEL||DATA.mergedWheel)[idx].label; document.getElementById('wheelBadge').textContent=pick; log("Wheel ‚Üí "+pick); handleWheelOutcome(pick, wheelCanvas); }); });

  document.getElementById('spinBuilder').addEventListener('click', function(){ document.getElementById('builderBadge').textContent='Spinning‚Ä¶'; if(!STATE.difficulty) STATE.difficulty = pickUniform(DATA.difficulty); var keys=['scenario','hoods','gags','extras','anal','fm','location','position','wand','audio','restriction','nipples','estim','collar']; for(var i=0;i<keys.length;i++){ var k=keys[i]; var v=spinCategory(k); var el=document.getElementById('val-'+k); if(el) el.textContent=v; } document.getElementById('val-difficulty').textContent = STATE.difficulty; document.getElementById('builderBadge').textContent='Done'; summarize(); });
  var spinBtns=document.querySelectorAll('[data-spin]'); for(var i=0;i<spinBtns.length;i++){ spinBtns[i].addEventListener('click', function(e){ var key=e.target.getAttribute('data-spin'); if(key==='difficulty'){ STATE.difficulty = pickUniform(DATA.difficulty); document.getElementById('val-difficulty').textContent=STATE.difficulty; } else { var v=spinCategory(key); var el=document.getElementById('val-'+key); if(el) el.textContent=v; } summarize(); }); }

  document.getElementById('rollD10').addEventListener('click', function(){ rollD10Visual(document.getElementById('d10'), function(){ applyXEverywhere(); summarize(); }); });
  document.getElementById('spinPun').addEventListener('click', function(){ spinOutcome('punishment') });
  document.getElementById('spinRew').addEventListener('click', function(){ spinOutcome('reward') });

  bindTimer();

  document.getElementById('exportJson').addEventListener('click', exportSession);
  document.getElementById('exportLog').addEventListener('click', exportLog);
  document.getElementById('importJson').addEventListener('change', function(e){ var f=e.target.files[0]; if(!f) return; importSession(f, function(){ document.getElementById('wheelBadge').textContent=STATE.lengthLabel||'‚Äî'; document.getElementById('d10').textContent=STATE.d10||'‚Äî'; var keys=['difficulty','scenario','hoods','gags','extras','anal','fm','location','position','wand','audio','restriction','nipples','estim','collar','punishment','reward']; for(var i=0;i<keys.length;i++){ var k=keys[i]; var v=STATE.picks[k]||'‚Äî'; var el=document.getElementById('val-'+k); if(el) el.textContent=v; } document.getElementById('sessMins').value=STATE.lengthMins||''; summarize(); }); });

  document.getElementById('shareSnapshot').addEventListener('click', shareSnapshotLink);
  summarize();
}
document.addEventListener('DOMContentLoaded', init);

// --- Publish default prep/session mins and bind inputs (safe, idempotent) ---
document.addEventListener('DOMContentLoaded', function(){
  try{
    var prepEl = document.getElementById('prepMins');
    if(prepEl && !prepEl.dataset.bound){
      prepEl.dataset.bound = "1";
      var pushPrep = function(){
        var v = parseInt(prepEl.value,10);
        if(isFinite(v) && v>=0){ STATE.prepMins = v; postStateDebounced(); }
      };
      prepEl.addEventListener('input', pushPrep);
      pushPrep(); // publish default immediately
    }
    var sessEl = document.getElementById('sessMins');
    if(sessEl && !sessEl.dataset.bound){
      sessEl.dataset.bound = "1";
      sessEl.addEventListener('input', function(){
        var v = parseInt(sessEl.value,10);
        if(isFinite(v) && v>0){
          STATE.lengthMins = v;
          STATE.lengthLabel = v + " mins";
          postStateDebounced();
        }
      });
    }
  }catch(_){}
});
</script>


<script>
// --- Robust Lock Handler Patch (v3.5-lockfix) ---
(function(){
  const LOCK_KEY="ecc_pass_hash_v1";
  const LOCKED_FLAG="ecc_locked_v1";

  // Fallback hash to avoid WebCrypto dependency issues
  function simpleHash(str){
    let h=0, i, chr;
    if (str.length === 0) return '0';
    for (i = 0; i < str.length; i++) {
      chr = str.charCodeAt(i);
      h = ((h << 5) - h) + chr;
      h |= 0;
    }
    return String(h);
  }

  function showLockOverlay(show){
    const o = document.getElementById("lockOverlay");
    if (o) o.style.display = show ? "flex" : "none";
  }

  function resetLock(){
    try {
      localStorage.removeItem(LOCK_KEY);
      localStorage.removeItem(LOCKED_FLAG);
    } catch(e){}
  }

  async function tryUnlock(pin){
    const msg = document.getElementById("lockMsg");
    if(!pin || pin.length < 4 || pin.length > 8){
      if(msg) msg.textContent = "Enter 4‚Äì8 digits.";
      return false;
    }
    // try WebCrypto first; fall back to simpleHash
    let hashed;
    try {
      const enc = new TextEncoder().encode(pin);
      const buf = await (crypto.subtle && crypto.subtle.digest ? crypto.subtle.digest("SHA-256", enc) : Promise.reject("no-webcrypto"));
      const hex = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
      hashed = hex;
    } catch(e){
      hashed = simpleHash(pin);
    }
    const saved = localStorage.getItem(LOCK_KEY);
    if(!saved){
      // first code set
      localStorage.setItem(LOCK_KEY, hashed);
      localStorage.removeItem(LOCKED_FLAG);
      return true;
    }
    if(saved === hashed){
      localStorage.removeItem(LOCKED_FLAG);
      return true;
    }
    if(msg) msg.textContent = "Incorrect code.";
    return false;
  }

  function bindNow(){
    const inp = document.getElementById("lockInput");
    const ok = document.getElementById("lockSubmit");
    const panic = document.getElementById("panicHide");
    const btnLock = document.getElementById("btnLockNow");
    const btnPanic = document.getElementById("btnPanic");
    const forgot = document.getElementById("forgotCode");

    if (ok) ok.onclick = async function(){
      const pin = (inp && inp.value || "").trim();
      const okd = await tryUnlock(pin);
      if (okd) showLockOverlay(false);
    };
    if (inp) inp.onkeydown = async function(e){
      if(e.key === "Enter"){
        const okd = await tryUnlock((inp.value || "").trim());
        if (okd) showLockOverlay(false);
      }
    };
    function panicHideNow(){
      try { localStorage.setItem(LOCKED_FLAG, "1"); } catch(e){}
      document.body.innerHTML = "<div style='position:fixed;inset:0;background:#0a0e1d'></div>";
    }
    if (panic) panic.onclick = panicHideNow;
    if (btnPanic) btnPanic.onclick = panicHideNow;
    if (btnLock) btnLock.onclick = function(){
      try { localStorage.setItem(LOCKED_FLAG, "1"); } catch(e){}
      showLockOverlay(true);
      if (inp){ inp.value = ""; inp.focus(); }
    };
    if (forgot) forgot.onclick = function(){
      resetLock();
      const msg = document.getElementById("lockMsg");
      if (msg) msg.textContent = "Lock reset. Enter a NEW 4‚Äì8 digit code.";
      showLockOverlay(true);
      if (inp){ inp.value = ""; inp.focus(); }
    };

    // honor URL reset flags
    if (/[#?].*(reset=1|#reset)/.test(location.href)) {
      resetLock();
    }

    // initial visibility
    const locked = localStorage.getItem(LOCKED_FLAG) === "1";
    showLockOverlay(locked);
  }

  if (document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", bindNow);
  } else {
    bindNow();
  }
})();
</script>




















<script id="ecc-live-sync-v6">
(function(){
  "use strict";
  var ROOM="main";
  var POST="/.netlify/functions/save-state";
  var lastJSON="";

  function $all(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }
  function txt(n){ return (n && (n.innerText||n.textContent)||"").replace(/\s+/g," ").trim(); }
  function vis(n){ var cs=getComputedStyle(n); return cs.display!=="none" && cs.visibility!=="hidden" && (+cs.opacity||1)>0.01; }
  function mmssToSec(s){ var m=String(s||"").match(/(\d{1,2}):(\d{2})/); return m? (parseInt(m[1],10)*60+parseInt(m[2],10)) : 0; }
  function secToMinRoundUp(s){ if(!s) return null; return Math.max(1, Math.round(s/60)); }

  // ---------- Timers ----------
  function findTimerNode(label){
    var nodes=$all("body *:not(script):not(style)");
    var re=new RegExp("\\b"+label+"\\b","i");
    var best=null, bestSize=0;
    for(var i=0;i<nodes.length;i++){
      var n=nodes[i]; if(!vis(n)) continue;
      var t=txt(n);
      if(re.test(t) && /\d{1,2}:\d{2}/.test(t)){
        var sz=parseFloat(getComputedStyle(n).fontSize||"16");
        if(sz>bestSize){ best=n; bestSize=sz; }
      }
    }
    return best;
  }
  function readTimer(label){
    var node=findTimerNode(label);
    if(!node) return 0;
    return mmssToSec(txt(node));
  }

  function readNumberByLabel(label){
    var nodes=$all("body *:not(script):not(style)");
    var re=new RegExp(label.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i");
    for(var i=0;i<nodes.length;i++){
      var n=nodes[i]; if(!vis(n)) continue;
      if(re.test(txt(n))){
        // search next siblings
        for(var j=i+1;j<i+60 && j<nodes.length;j++){
          var el=nodes[j]; if(!vis(el)) continue;
          if(el.matches && el.matches("input")){
            var v=parseInt(el.value||el.getAttribute("value")||"",10); if(!isNaN(v)) return v;
          }
          var role=el.getAttribute && el.getAttribute("role");
          if(role && /spinbutton/i.test(role)){
            var vv=el.getAttribute("aria-valuenow")||el.getAttribute("aria-valuetext")||txt(el);
            var n2=parseInt(vv,10); if(!isNaN(n2)) return n2;
          }
          var m=txt(el).match(/\b(\d{1,3})\b/);
          if(m){ var n3=parseInt(m[1],10); if(!isNaN(n3)) return n3; }
        }
        break;
      }
    }
    return null;
  }

  function readTimerMinsFallback(){
    // find a Start button, then collect number inputs in the same block
    var btns=$all("button, .btn, [role='button']");
    var start=null;
    for(var i=0;i<btns.length;i++){
      var t=txt(btns[i]).toLowerCase();
      if(/start\s*prep\+?session/.test(t) || /start\s*session/.test(t)){ start=btns[i]; break; }
    }
    if(!start) return {prep:null, sess:null};
    var host=start;
    for(var up=0; up<4 && host && host.parentElement; up++) host=host.parentElement;
    if(!host) host=document.body;
    var vals=[];
    $all("input[type=number]", host).forEach(function(n){ var v=parseInt(n.value||n.getAttribute("value")||"",10); if(!isNaN(v)) vals.push(v); });
    $all("[role='spinbutton']", host).forEach(function(n){ var v=parseInt(n.getAttribute("aria-valuenow")||n.getAttribute("aria-valuetext")||txt(n),10); if(!isNaN(v)) vals.push(v); });
    // Heuristic: first = prep, last/second = session
    if(vals.length>=2) return {prep: vals[0], sess: vals[vals.length-1]};
    if(vals.length===1) return {prep: vals[0], sess: null};
    return {prep:null, sess:null};
  }

  // ---------- Picks ----------
  var PICK_LABELS=[
    "Scenario / Clothing","Scenario/Clothing","Hoods","Gags","Extras","Anal","Fucking Machine","Location",
    "Position","Vibrating Wand","Audio","Restriction","Nipples","E-Stim","E‚ÄëStim","Collar"
  ];
  function cleanVal(v){
    var t=String(v||"").trim();
    t=t.replace(/Length\\s*\\/\\s*Result/ig,"").replace(/\\bWheel\\b/ig,"").replace(/\\bSpin\\b/ig,"");
    t=t.replace(/\\b\\d+\\s*(mins?|s)\\b/ig,"").replace(/\\s{2,}/g," ").trim();
    if(t.length>120 && /[,‚Ä¢/|-]/.test(t)) t=t.split(/[,‚Ä¢/|-]/)[0].trim();
    return t;
  }
  function valueNear(label){
    var nodes=$all("body *:not(script):not(style)");
    var re=new RegExp(label.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&"),"i");
    for(var i=0;i<nodes.length;i++){
      var n=nodes[i]; if(!vis(n)) continue;
      if(re.test(txt(n))){
        // Try same-row/sibling
        var sib=n.nextElementSibling;
        if(sib && vis(sib)){ var v=cleanVal(txt(sib)); if(v && v!=='‚Äî' && v!=='-') return v; }
        // Try selected toggles inside the same section/card
        var host=n; for(var up=0; up<4 && host && host.parentElement; up++) host=host.parentElement;
        if(host){
          var selected=$all("[aria-checked='true'],[aria-pressed='true'],[aria-selected='true'],.selected,.active, input:checked + label", host)
            .map(function(el){ return cleanVal(txt(el)); })
            .filter(Boolean);
          if(selected.length){ return selected.join(", "); }
        }
        // Try the next few nodes
        for(var j=i+1;j<i+14 && j<nodes.length;j++){
          var v2=cleanVal(txt(nodes[j])); if(v2 && v2!=='‚Äî' && v2!=='-') return v2;
        }
        break;
      }
    }
    return "";
  }
  function picksFromTable(){
    // If the Builder renders a "Builder Picks" table, parse it
    var headers=$all("*").filter(function(n){ return vis(n) && /^builder picks$/i.test(txt(n)); });
    if(!headers.length) return {};
    var card=headers[0]; for(var up=0; up<3 && card && card.parentElement; up++) card=card.parentElement;
    if(!card) return {};
    var kv=$all("*", card);
    var out={};
    for(var i=0;i<kv.length-1;i++){
      var k=txt(kv[i]), v=txt(kv[i+1]);
      if(PICK_LABELS.some(function(lbl){ return new RegExp(lbl.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&"),"i").test(k); }) && v && v!=="‚Äî"){
        out[k]=cleanVal(v);
        i++;
      }
    }
    return out;
  }
  function picksFromGlobals(){
    var out={};
    try{
      for(var i=0;i<localStorage.length;i++){
        var key=localStorage.key(i);
        if(!/state|store|ecc|control|session|builder|picks|results/i.test(key)) continue;
        try{
          var v=JSON.parse(localStorage.getItem(key));
          if(v && v.picks){ for(var kk in v.picks){ out[kk]=v.picks[kk]; } }
          if(v && v.results && v.results.picks){ for(var kk in v.results.picks){ out[kk]=v.results.picks[kk]; } }
        }catch(_){}
      }
    }catch(_){}
    try{
      for(var k in window){
        if(!Object.prototype.hasOwnProperty.call(window,k)) continue;
        if(!/state|store|ecc|control|session|builder|picks|results/i.test(k)) continue;
        var val=window[k];
        if(val && typeof val==="object"){
          if(val.picks){ for(var kk in val.picks){ out[kk]=val.picks[kk]; } }
          if(val.results && val.results.picks){ for(var kk in val.results.picks){ out[kk]=val.results.picks[kk]; } }
        }
      }
    }catch(_){}
    return out;
  }

  function buildState(){
    var prepSec=readTimer("Prep");
    var sessSec=readTimer("Session");

    var prepM=readNumberByLabel("Prep (mins)");
    var sessM=readNumberByLabel("Session (mins)");
    if(prepM==null || sessM==null){
      var fb=readTimerMinsFallback();
      if(prepM==null) prepM=fb.prep;
      if(sessM==null) sessM=fb.sess;
    }
    if(prepM==null) prepM=secToMinRoundUp(prepSec); // last-resort

    var picks={};
    PICK_LABELS.forEach(function(lbl){ var v=valueNear(lbl); if(v) picks[lbl]=v; });
    var tab=picksFromTable(); for(var k in tab){ if(!picks[k]) picks[k]=tab[k]; }
    var gp=picksFromGlobals(); for(var k2 in gp){ if(!picks[k2]) picks[k2]=gp[k2]; }

    var st={
      lengthLabel:"",
      lengthMins: (sessM!=null ? sessM : null),
      prepMins: (prepM!=null ? prepM : null),
      sessionMins: (sessM!=null ? sessM : null),
      difficulty: valueNear("^Difficulty$") || null,
      picks: picks,
      d10: valueNear("^d10") || null,
      notes: [],
      outcomes: { punishment: valueNear("^Punishment$")||"", reward: valueNear("^Reward$")||"" },
      timers: { prep: prepSec, session: sessSec, which: null, end: null },
      updatedAt: Date.now()
    };
    return st;
  }

  async function post(st){
    try{ await fetch(POST,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({room:ROOM,state:st})}); }catch(_){}
  }

  function tick(){
    var st=buildState();
    var j=JSON.stringify(st);
    if(j!==lastJSON){ lastJSON=j; post(st); }
  }
  if(document.readyState==="loading"){ document.addEventListener("DOMContentLoaded", tick); } else { tick(); }
  setInterval(tick, 900);
})();
</script>

<script id="ecc-control-listener-v2">
(function(){
  "use strict";
  var ROOM="main"; var lastSeq=0;
  function text(n){ return (n && (n.innerText||n.textContent)||"").trim(); }
  function clickBy(labels){
    var btns=Array.from(document.querySelectorAll("button, .btn, [role='button']"));
    for(var i=0;i<btns.length;i++){
      var t=text(btns[i]).toLowerCase().replace(/\s+/g,' ');
      if(labels.some(function(l){ return t.indexOf(l)>=0; })){ btns[i].click(); return true; }
    }
    return false;
  }
  async function poll(){
    try{
      var r=await fetch("/.netlify/functions/get-state?room="+ROOM+"&x="+(Date.now()%1e7));
      var j=await r.json(); var st=j && j.state; if(!st||!st.control) return;
      if(st.control.seq && st.control.seq<=lastSeq) return;
      lastSeq=st.control.seq||Date.now();
      var cmd=(st.control.cmd||"").toLowerCase();
      if(cmd==="startprepsession"){ clickBy(["start prep+session","start prep + session","start prep session","start prep"]); }
      else if(cmd==="startsession"){ clickBy(["start session"]); }
      else if(cmd==="pause"){ clickBy(["pause"]); }
      else if(cmd==="resume"){ clickBy(["resume"]); }
      else if(cmd==="reset"){ clickBy(["reset"]); }
    }catch(_){}
  }
  setInterval(poll, 1200);
})();
</script>

</body>
</html>
