<!doctype html>
<meta charset="utf-8">
<title>Erin’s Control Centre — Builder (AutoScan)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0b1020;color:#e9ecf4;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:#0e1428;border-bottom:1px solid #222844}
h1{font-size:18px;margin:0}
.badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2b355f;background:#172046}
.btn{padding:10px 14px;border:1px solid #2b355f;background:#172046;color:#e9ecf4;border-radius:10px;cursor:pointer}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.clock{font-size:40px;font-weight:700;letter-spacing:.05em}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:#0f1428;border:1px solid #222844;border-radius:14px;padding:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
#prepFace:not(.clock), #sessFace:not(.clock){display:none!important}
#syncDebug{position:fixed;right:10px;bottom:10px;z-index:9999;background:rgba(15,20,40,.94);color:#e9ecf4;border:1px solid #2a2f54;border-radius:12px;padding:12px;max-width:440px;font:12px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;box-shadow:0 10px 30px rgba(0,0,0,.4)}
#syncDebug h3{margin:0 0 6px;font-size:13px}
#syncDebug pre{max-height:180px;overflow:auto;background:#0b1020;border:1px solid #222844;padding:6px 8px;border-radius:8px}
#syncDebug button{font-size:12px;padding:6px 10px;border-radius:8px;border:1px solid #38407a;background:#172046;color:#e9ecf4;cursor:pointer}
#syncDebug .row{display:flex;gap:8px;align-items:center;margin:6px 0}
</style>
<header>
  <h1>Erin’s Control Centre — Builder (AutoScan)</h1>
  <span class="badge">Room: <span id="room">main</span></span>
  <a class="btn" href="companion.html?room=main" target="_blank">Open Companion</a>
</header>
<div class="wrap">
  <div class="grid">
    <section class="card"><h2>Prep</h2><div id="prepFace" class="clock">00:00</div></section>
    <section class="card"><h2>Session</h2><div id="sessFace" class="clock">00:00</div></section>
  </div>
  <p class="note">This simplified builder is for testing live sync only.</p>
</div>
<script>
(function(){
  var ROOM=(function(){try{var m=location.search.match(/[?&]room=([^&]+)/);return m?decodeURIComponent(m[1]):'main';}catch(_){return'main';}})();
  var qsRoomEl=document.getElementById('room');if(qsRoomEl)qsRoomEl.textContent=ROOM;
  function txt(el){if(!el)return'';var s=(el.textContent||el.value||'').trim();return s;}
  function $(s){return document.querySelector(s);}
  function getAllPickValues(){var out={};document.querySelectorAll('[id^="val-"]').forEach(function(n){out[n.id.replace(/^val-/,'')]=txt(n);});var keys=['scenario','hoods','gags','extras','anal','fm','location','position','wand','audio','restriction','nipples','estim','collar','punishment','reward'];if(Object.keys(out).length===0){keys.forEach(function(k){var el=document.getElementById('val-'+k)||document.querySelector('[data-key="'+k+'"]');if(el)out[k]=txt(el);});}return out;}
  function parseMMSSAny(s){if(!s)return 0;var m=String(s).match(/(\d{1,2}):(\d{2})/);if(!m)return 0;return(parseInt(m[1],10)*60+parseInt(m[2],10))*1000;}
  function getTimerFace(id){var el=document.querySelector('#'+id+'.clock')||document.getElementById(id);if(el)return parseMMSSAny(txt(el));return 0;}
  function buildState(){var d10Text=txt($('#d10'))||txt($('#val-d10'));var d10=parseInt(d10Text,10);if(!Number.isFinite(d10))d10=null;var difficulty=txt($('#val-difficulty'))||txt($('#difficulty'))||null;var picks=getAllPickValues();var timers={prep:getTimerFace('prepFace'),session:getTimerFace('sessFace'),which:null,end:null};return{lengthLabel:null,lengthMins:null,difficulty:difficulty||null,picks:picks,d10:d10,notes:[],timers:timers};}
  var lastSent='';var inflight=false;function pushState(force){try{var st=buildState();var json=JSON.stringify({room:ROOM,state:st});if(!force&&json===lastSent)return;lastSent=json;if(inflight)return;inflight=true;fetch('/.netlify/functions/save-state',{method:'POST',headers:{'Content-Type':'application/json'},body:json}).catch(function(_){ }).finally(function(){inflight=false;});}catch(_){}}setInterval(function(){pushState(false);},1500);window.addEventListener('click',function(){setTimeout(function(){pushState(false);},80);},true);document.addEventListener('visibilitychange',function(){if(document.visibilityState==='hidden')pushState(true);});window.__ECC_PUSH__=function(){pushState(true);};if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){pushState(true);});}else{pushState(true);} })();
</script>
<div id="syncDebug" role="region" aria-label="Live Sync Debug">
  <h3>Live Sync Debug</h3>
  <div class="row"><button id="forceSyncBtn" type="button">Force Sync</button>
    <a id="dbgOpenComp" href="companion.html?room=main" target="_blank" style="color:#9bb0ff">Open Companion</a></div>
  <div>Room: <span id="dbgRoom">main</span></div>
  <div>Status: <span id="dbgStatus">idle</span></div>
  <div>Last POST bytes: <span id="dbgBytes">0</span></div>
  <div>Last get-state updatedAt: <span id="dbgUpdated">0</span></div>
  <div>Payload preview:</div><pre id="dbgPayload">{}</pre></div>
<script>
(function(){function $(s){return document.querySelector(s);}var ROOM=(function(){var m=location.search.match(/[?&]room=([^&]+)/);return m?decodeURIComponent(m[1]):'main';})();$('#dbgRoom').textContent=ROOM;$('#dbgOpenComp').href='companion.html?room='+encodeURIComponent(ROOM);function buildPayload(){try{return JSON.stringify({room:ROOM,state:(function(){var d10Text=($('#d10')&&$('#d10').textContent.trim())||($('#val-d10')&&$('#val-d10').textContent.trim())||'';var d10=parseInt(d10Text,10);if(!Number.isFinite(d10))d10=null;function tx(e){return e?(e.textContent||e.value||'').trim():'';}var picks={};document.querySelectorAll('[id^="val-"]').forEach(function(n){picks[n.id.replace(/^val-/,'')]=tx(n);});var timers={prep:(function(s){var m=String(s).match(/(\d{1,2}):(\d{2})/);return m?((+m[1]*60+ +m[2])*1000):0;})((document.querySelector('#prepFace.clock')||document.getElementById('prepFace')||{}).textContent||''),session:(function(s){var m=String(s).match(/(\d{1,2}):(\d{2})/);return m?((+m[1]*60+ +m[2])*1000):0;})((document.querySelector('#sessFace.clock')||document.getElementById('sessFace')||{}).textContent||''),which:null,end:null};return{lengthLabel:null,lengthMins:null,difficulty:(tx($('#val-difficulty'))||tx($('#difficulty'))||null),d10,notes:[],picks,timers};})()});}catch(e){return JSON.stringify({room:ROOM,state:null,error:String(e)});} } async function postOnce(){var json=buildPayload();$('#dbgPayload').textContent=json;$('#dbgBytes').textContent=json.length;$('#dbgStatus').textContent='posting…';try{const r=await fetch('/.netlify/functions/save-state',{method:'POST',headers:{'Content-Type':'application/json'},body:json});const j=await r.json().catch(()=>({}));$('#dbgStatus').textContent='POST '+r.status+(j&&j.ok?' (ok)':'');const g=await fetch('/.netlify/functions/get-state?room='+encodeURIComponent(ROOM));const gj=await g.json();$('#dbgUpdated').textContent=String(gj&&gj.updatedAt||0);}catch(e){$('#dbgStatus').textContent='error: '+e;}}$('#forceSyncBtn').addEventListener('click',postOnce);})();
</script>
