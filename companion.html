
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Companion</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{background:#0b1020;color:#e9ecf4;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
  header{display:flex;gap:10px;padding:12px 16px;background:#0e1428;border-bottom:1px solid #222844;position:sticky;top:0;align-items:center;flex-wrap:wrap}
  h1{font-size:18px;margin:0}
  .badge{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid #2b355f;background:#172046}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .card{background:#0f1428;border:1px solid #222844;border-radius:14px;padding:12px}
  .kv{display:grid;grid-template-columns:200px 1fr;gap:8px}.kv div:nth-child(odd){color:#aab1bf}.kv div:nth-child(even){font-weight:600}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  .controls button{padding:8px 12px;border:1px solid #38407a;background:#172046;color:#e9ecf4;border-radius:10px;cursor:pointer}
  @media(max-width:800px){.grid{grid-template-columns:1fr}.kv{grid-template-columns:140px 1fr}}
  .small{font-size:12px;color:#96a0b8}
  .right{margin-left:auto;display:flex;gap:8px;align-items:center}
</style>

<style id="hover-fix-final">
.controls button:hover{ filter:brightness(1.08) !important; border-color:#40509a !important; box-shadow:0 0 0 2px rgba(64,80,154,.25) inset !important; }
.controls button:active{ transform:translateY(1px) !important; }
.controls button:focus{ outline:2px solid #40509a !important; outline-offset:2px !important; }
</style>

</head>
<body>
<header>
  <h1>Companion</h1>
  <span class="badge">Last update: <span id="ts">—</span></span>
  <div class="right">
    <button id="enableSound" class="badge" title="Click once to enable beeps/chime">Enable Sound</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card"><h2>Timers</h2>
      <div class="kv">
        <div>Prep</div><div id="prepTimer">00:00</div>
        <div>Session</div><div id="sessTimer">00:00</div>
        <div>Prep length</div><div id="prepLen">—</div>
        <div>Session length</div><div id="sessLen">—</div>
      </div>
      <div class="controls">
        <button id="btnStartPrepSession">Start Prep+Session</button>
        <button id="btnStartSession">Start Session</button>
        <button id="btnPause">Pause</button>
        <button id="btnResume">Resume</button>
        <button id="btnReset">Reset</button>
      </div>
      <div class="small">Audio is Companion-only. Click <em>Enable Sound</em> once to allow beeps.</div>
    </section>

    <section class="card"><h2>Session</h2>
      <div class="kv">
<div>d10 (X)</div><div id="d10">—</div>
        <div>Punishment</div><div id="punishment">—</div>
        <div>Reward</div><div id="reward">—</div>
</div>
    </section>

    <section class="card"><h2>Builder Picks</h2>
      <div class="kv" id="picksKv">
        <div>Difficulty</div><div id="difficulty">—</div>
        <div>Scenario / Clothing</div><div id="Scenario / Clothing">—</div>
        <div>Hoods</div><div id="Hoods">—</div>
        <div>Gags</div><div id="Gags">—</div>
        <div>Extras</div><div id="Extras">—</div>
        <div>Anal</div><div id="Anal">—</div>
        <div>Fucking Machine</div><div id="Fucking Machine">—</div>
        <div>Location</div><div id="Location">—</div>
        <div>Position</div><div id="Position">—</div>
        <div>Vibrating Wand</div><div id="Vibrating Wand">—</div>
        <div>Audio</div><div id="Audio">—</div>
        <div>Restriction</div><div id="Restriction">—</div>
        <div>Nipples</div><div id="Nipples">—</div>
        <div>E-Stim</div><div id="E-Stim">—</div>
        <div>Collar</div><div id="Collar">—</div>
      </div>
    </section>
  
    <section class="card"><h2>Notes &amp; Wheel Modifiers</h2>
      <div class="kv"><div>Manual Notes</div><div><pre id="notesDisplay" style="white-space:pre-wrap;word-wrap:break-word;margin:0;background:#0b0b0b12;padding:.5rem;border-radius:.5rem;min-height:2.2rem;"></pre></div>
      <div>Wheel Modifiers</div><div><ul id="modifiersDisplay" style="margin:0;padding-left:18px;max-height:200px;overflow:auto"></ul></div></div>
      <ul id="notesList" style="margin:0;padding-left:18px;max-height:200px;overflow:auto"></ul>
    </section>
</div>
</div>

<script>
(function(){
  "use strict";
  // ====== Config ======
  var ROOM = 'main'; // still supported via #room=; not displayed
  try{
    const m = location.hash.match(/room=([a-z0-9_-]{1,64})/i);
    if(m){ ROOM = m[1].toLowerCase(); }
  }catch(_){}

  // ====== Audio (Companion-only) ======
  let AUDIO_ENABLED = false;
  let ECC_AUDIO_CTX;
  function getAudioCtx(){
    if(!ECC_AUDIO_CTX){
      const AC = window.AudioContext || window.webkitAudioContext;
      if(!AC) return null;
      ECC_AUDIO_CTX = new AC();
    }
    if (ECC_AUDIO_CTX && ECC_AUDIO_CTX.state === 'suspended'){
      ECC_AUDIO_CTX.resume().catch(()=>{});
    }
    return ECC_AUDIO_CTX;
  }
  function beep({freq=880, ms=120, gain=0.15}={}){
    try{
      if(!AUDIO_ENABLED) return;
      const ctx = getAudioCtx(); if(!ctx) return;
      const osc = ctx.createOscillator();
      const amp = ctx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq;
      amp.gain.value = gain;
      osc.connect(amp); amp.connect(ctx.destination);
      const now = ctx.currentTime;
      osc.start(now); osc.stop(now + ms/1000);
    }catch(_){}
  }
  async function playBeeps(n=3, gapMs=180, options={}){
    for(let i=0;i<n;i++){
      beep(options);
      // eslint-disable-next-line no-await-in-loop
      await new Promise(r=>setTimeout(r, gapMs));
    }
  }
  function playEndChime(){
    beep({freq:660, ms:140, gain:0.16});
    setTimeout(()=>beep({freq:880, ms:220, gain:0.16}), 170);
  }
  function enableAudio(){
    AUDIO_ENABLED = true;
    getAudioCtx();
    const b = document.getElementById('enableSound');
    if (b) b.textContent = 'Sound Enabled';
  }
  document.getElementById('enableSound').addEventListener('click', enableAudio, {once:false});

  // ====== Utilities ======
  function set(id,val){ var el=document.getElementById(id); if(el){ el.textContent=(val==null||val==='')?'—':val; } }
  function fmtMMSSFromMs(ms){
    const s = Math.max(0, Math.floor((+ms||0)/1000));
    const m = Math.floor(s/60), ss = s % 60;
    return (''+m).padStart(2,'0')+':'+(''+ss).padStart(2,'0');
  }
  function normKey(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
  function smartString(v){
    if(v==null) return "";
    if(typeof v==="object"){
      if(Array.isArray(v)) return v.map(smartString).filter(Boolean).join(", ");
      return Object.values(v).map(smartString).filter(Boolean).join(", ");
    }
    if(v===true) return "Yes";
    if(v===false) return "No";
    return String(v).trim();
  }
  function mapPickValue(picks, displayId){
    if(!picks) return "";
    const want = normKey(displayId);
    const aliasesMap = {
      "Scenario / Clothing": ["scenario/clothing","scenario / clothing","scenario","clothing"],
      "Vibrating Wand": ["vibratingwand","wand","vibe","vibrator"],
      "E-Stim": ["e-stim","estim","e—stim","electrostim","electro","electroplay"],
      "Fucking Machine": ["fuckingmachine","fmachine","f-machine","machine","sexmachine","thrust","thrusting","autothrust","auto-thrust","autothrustingmachine","automatictmachine","fm"]
    };
    const aliases = (aliasesMap[displayId] || []).map(normKey);
    const keys = Object.keys(picks);
    if (picks[displayId] != null) return smartString(picks[displayId]);
    for (const k of keys){
      const nk = normKey(k);
      if (nk === want || aliases.includes(nk)){ return smartString(picks[k]); }
    }
    for (const k of keys){
      const nk = normKey(k);
      if (nk.includes(want) || aliases.some(a => nk.includes(a))){ return smartString(picks[k]); }
    }
    return "";
  }

  async function get(){ const r=await fetch('/.netlify/functions/get-state?room='+ROOM+'&x='+(Date.now()%1e7)); return r.json(); }
  async function postCommand(cmd){
    try{
      await fetch('/.netlify/functions/c4-command', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ room: ROOM, cmd })
      });
    }catch(_){}
  }

  // ====== Drift-smoothed live countdown ======
  let lastState = null;
  let liveTimer = null;
  let lastSessionMinuteAnnounced = null;
  let lastRunning = false;
  const live = { mode: null, end: null, sessionTotalMinutes: null };

  function updateEndFromSnapshot(t){
    const now = Date.now();
    const incomingMode = t.which || null;

    let proposedEnd = null;
    if (t.end) {
      proposedEnd = t.end;
    } else if (incomingMode === 'prep' && t.prep) {
      proposedEnd = now + (+t.prep||0);
    } else if (incomingMode === 'session' && t.session) {
      proposedEnd = now + (+t.session||0);
    }

    if (incomingMode !== live.mode){
      live.mode = incomingMode;
      live.end = proposedEnd;

      if (incomingMode === 'session'){
        if (lastState){
          const st = lastState;
          let sessLen = st.lengthMins ?? st.session_minutes ?? null;
          if (sessLen == null){
            const remainMs = (+t.session||0);
            sessLen = Math.max(1, Math.round(remainMs/60000));
          }
          live.sessionTotalMinutes = sessLen;
          set('sessLen', sessLen + ' min');
        }
      } else {
        live.sessionTotalMinutes = null;
      }
      lastSessionMinuteAnnounced = null;
      return;
    }

    if (proposedEnd != null && live.end != null){
      const drift = Math.abs(proposedEnd - live.end);
      if (drift > 1500){
        live.end = proposedEnd;
      }
    } else if (proposedEnd != null && live.end == null){
      live.end = proposedEnd;
    }
  }

  function renderLive(){
    if(!lastState) return;
    const t = lastState.timers || {};
    const now = Date.now();

    updateEndFromSnapshot(t);

    let prepRemain = t.prep || 0;
    let sessRemain = t.session || 0;

    if (live.mode === 'prep' && live.end){
      prepRemain = Math.max(0, live.end - now);
    } else if (live.mode === 'session' && live.end){
      sessRemain = Math.max(0, live.end - now);
    }

    set('prepTimer', fmtMMSSFromMs(prepRemain));
    set('sessTimer', fmtMMSSFromMs(sessRemain));

    if (live.mode === 'session' && live.sessionTotalMinutes != null){
      set('sessLen', live.sessionTotalMinutes + ' min');
    }

    const running = !!(t.which && (t.end || live.end));
    const mins = Math.floor((sessRemain/1000) / 60);
    if (mins !== lastSessionMinuteAnnounced){
      if (running){
        if (mins > 0 && mins % 10 === 0){
          playBeeps(3, 180, {freq:880, ms:110, gain:0.14});
        }
        if (mins === 0 && lastSessionMinuteAnnounced !== null){
          playEndChime();
        }
      }else if (lastRunning && mins === 0){
        playEndChime();
      }
      lastSessionMinuteAnnounced = mins;
    }
    lastRunning = running;
  }

  function ensureLiveLoop(){
    if (!liveTimer){
      liveTimer = setInterval(renderLive, 250);
    }
  }

  // ====== Apply state to UI ======
  function apply(st){
    lastState = st;
    const t = st.timers || {};

    const prepMinutes = st.prepMins ?? st.prep_minutes ?? null;
    set('prepLen', prepMinutes==null ? '—' : (prepMinutes + ' min'));

    const explicitSess = st.lengthMins ?? st.session_minutes ?? null;
    if (explicitSess != null){
      live.sessionTotalMinutes = explicitSess;
      set('sessLen', explicitSess + ' min');
    } else if (live.sessionTotalMinutes != null){
      set('sessLen', live.sessionTotalMinutes + ' min');
    } else {
      set('sessLen', '—');
    }

    set('difficulty', st.difficulty || '—');
    set('d10', st.d10 == null ? '—' : st.d10);
    set('punishment', (st.picks && (st.picks.punishment || st.picks.Punishment)) || '—');
    set('reward', (st.picks && (st.picks.reward || st.picks.Reward)) || '—');
    
    // Notes count
    set('notes', Array.isArray(st.notes) && st.notes.length ? String(st.notes.length) + ' note(s)' : '—');
    // Notes list
    (function(){
      var list = document.getElementById('notesList'); if(!list) return;
      list.innerHTML = '';
      if (Array.isArray(st.notes)){
        st.notes.slice(-50).forEach(function(n){
          var li = document.createElement('li');
          var t = (n && (n.text||n.note||n.msg)) || String(n);
          li.textContent = t;
          list.appendChild(li);
        });
      }
    })();


    const DISPLAY_IDS = [
      "Scenario / Clothing","Hoods","Gags","Extras","Anal","Fucking Machine",
      "Location","Position","Vibrating Wand","Audio","Restriction","Nipples","E-Stim","Collar"
    ];
    for (const id of DISPLAY_IDS){
      const v = mapPickValue(st.picks || {}, id);
      set(id, v || '—');
    }

    ensureLiveLoop();
  }

  // ====== Poll loop ======
  async function tick(){
    try{
      const js = await get();
      if (js && js.state){
        apply(js.state);
        const tsEl = document.getElementById('ts');
        if (tsEl){ tsEl.textContent = new Date(js.updatedAt || Date.now()).toLocaleTimeString(); }
      }
    }catch(_){}
    setTimeout(tick, 1000);
  }
  tick();

  // ====== Controls → c4-command ======
  document.getElementById('btnStartPrepSession').addEventListener('click', ()=>{ enableAudio(); postCommand('start-prep-session'); });
  document.getElementById('btnStartSession').addEventListener('click', ()=>{ enableAudio(); postCommand('start-session'); });
  document.getElementById('btnPause').addEventListener('click', ()=>{ postCommand('pause'); });
  document.getElementById('btnResume').addEventListener('click', ()=>{ enableAudio(); postCommand('resume'); });
  document.getElementById('btnReset').addEventListener('click', ()=>{ postCommand('reset'); });
})();
</script>

<script src="ecc-sync.js"></script>
<script>
// ECC local notes + current-session-only modifiers (non-invasive; timers untouched)
(function(){
  var notesEl = document.getElementById('notesDisplay');
  var modsEl  = document.getElementById('modifiersDisplay');

  function getSessionStart(){ var v = localStorage.getItem('ECC_SESSION_START'); return v ? Number(v) : null; }
  function setSessionStart(ts){ try{ localStorage.setItem('ECC_SESSION_START', String(ts||Date.now())); }catch(_){ } }
  function clearModifiers(){ try{ if(window.ECCSync && ECCSync.setModifiers) ECCSync.setModifiers([]); }catch(_){} }

  function parseStamp(line){
    // Expected: "9/7/2025, 17:03:22 — text"
    if (typeof line !== 'string') return null;
    var idx = line.indexOf(' — ');
    if (idx <= 0) return null;
    var stamp = line.slice(0, idx);
    var t = Date.parse(stamp);
    return isNaN(t) ? null : t;
  }

  function renderECC(){
    try{
      if (notesEl && window.ECCSync) {
        var txt = ECCSync.getNotes() || '';
        notesEl.textContent = txt || '—';
      }
      if (modsEl && window.ECCSync) {
        var arr = ECCSync.getModifiers() || [];
        var start = getSessionStart();
        var filtered = [];
        if (start) {
          for (var i=0;i<arr.length;i++){
            var ts = parseStamp(arr[i]);
            if (ts && ts >= start) filtered.push(arr[i]);
          }
        }
        modsEl.innerHTML = '';
        if (!start || !filtered.length) {
          var li = document.createElement('li'); li.textContent = '—'; modsEl.appendChild(li);
        } else {
          filtered.forEach(function(item){ var li = document.createElement('li'); li.textContent = item; modsEl.appendChild(li); });
        }
      }
    }catch(_){}
  }

  // Hook Companion controls (if present)
  function bind(id, fn){ var b=document.getElementById(id); if(b) b.addEventListener('click', fn); }
  function startNewSession(){ setSessionStart(Date.now()); clearModifiers(); setTimeout(renderECC, 10); } // clears modifiers on prep/session start or reset
  bind('btnStartPrepSession', startNewSession);
  bind('btnStartSession',     startNewSession);
  bind('btnReset',            startNewSession);

  // Detect transition to session from Builder via state apply(); do not alter timer logic
  try{
    var _apply = window.apply;
    if (typeof _apply === 'function'){
      var lastMode = null;
      window.apply = function(st){
        var r = _apply.apply(this, arguments);
        try{
          var which = (st && st.timers && st.timers.which) || null;
          if ((which === 'session' || which === 'prep') && lastMode !== which){
            startNewSession();
          }
          lastMode = which;
        }catch(_){}
        return r;
      };
    }
  }catch(_){}

  // Initial + live refresh via storage and periodic safety refresh
  renderECC();
  window.addEventListener('storage', function(ev){
    var k = (window.ECCSync && ECCSync.KEYS) || {};
    if(!ev || !k) return;
    if (ev.key===k.notes || ev.key===k.modifiers || ev.key===null) renderECC();
  });
  setInterval(renderECC, 5000);
})();
</script>

</body>
</html>
