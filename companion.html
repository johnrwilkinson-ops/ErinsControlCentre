
<!doctype html>
<meta charset="utf-8">
<title>Companion</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#0b1020;color:#e9ecf4;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0}
header{display:flex;gap:10px;padding:12px 16px;background:#0e1428;border-bottom:1px solid #222844;position:sticky;top:0}
h1{font-size:18px;margin:0}.badge{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid #2b355f;background:#172046}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.card{background:#0f1428;border:1px solid #222844;border-radius:14px;padding:12px}
.kv{display:grid;grid-template-columns:200px 1fr;gap:8px}.kv div:nth-child(odd){color:#aab1bf}.kv div:nth-child(even){font-weight:600}
.controls{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
\1

.controls button:hover{ background:#1b2752; border-color:#40509a; box-shadow:0 0 0 2px rgba(64,80,154,.25) inset; }
.controls button:active{ transform: translateY(1px); }
.controls button:focus{ outline:2px solid #40509a; outline-offset:2px; }

@media(max-width:800px){.grid{grid-template-columns:1fr}.kv{grid-template-columns:140px 1fr}}
.small{font-size:12px;color:#96a0b8}
</style>
<header><h1>Companion</h1><span class="badge">Room: <span id="room">main</span></span><span class="badge">Last update: <span id="ts">—</span></span></header>
<div class="wrap">
  <div class="grid">
    <section class="card"><h2>Timers</h2>
      <div class="kv">
        <div>Prep</div><div id="prepTimer">00:00</div>
        <div>Session</div><div id="sessTimer">00:00</div>
        <div>Prep length</div><div id="prepLen">—</div>
        <div>Session length</div><div id="sessLen">—</div>
      </div>
      <div class="controls">
        <button id="btnStartPrepSession">Start Prep+Session</button>
        <button id="btnStartSession">Start Session</button>
        <button id="btnPause">Pause</button>
        <button id="btnResume">Resume</button>
        <button id="btnReset">Reset</button>
      </div>
      
    </section>


    <section class="card"><h2>Session</h2>
      <div class="kv">
        <div>Difficulty</div><div id="difficulty">—</div>
        <div>d10 (X)</div><div id="d10">—</div>
        <div>Punishment</div><div id="punishment">—</div>
        <div>Reward</div><div id="reward">—</div>
        <div>Notes</div><div id="notes"><pre id="notesDisplay" style="white-space:pre-wrap;word-wrap:break-word;margin:0;background:#0b0b0b12;padding:.5rem;border-radius:.5rem;min-height:2.2rem;"></pre><div class="small" style="margin-top:6px;">Modifiers:</div><ul id="modifiersDisplay" style="margin:6px 0 0 1rem;"></ul></div><ul id="modifiersDisplay" style="margin:6px 0 0 1rem;"></ul></div><ul id="modifiersDisplay" style="margin:6px 0 0 1rem;"></ul></div>
      </div>
    </section>
    <section class="card"><h2>Builder Picks</h2>
      <div class="kv" id="picksKv">
        <div>Scenario / Clothing</div><div id="Scenario / Clothing">—</div>
        <div>Hoods</div><div id="Hoods">—</div>
        <div>Gags</div><div id="Gags">—</div>
        <div>Extras</div><div id="Extras">—</div>
        <div>Anal</div><div id="Anal">—</div>
        <div>Fucking Machine</div><div id="Fucking Machine">—</div>
        <div>Location</div><div id="Location">—</div>
        <div>Position</div><div id="Position">—</div>
        <div>Vibrating Wand</div><div id="Vibrating Wand">—</div>
        <div>Audio</div><div id="Audio">—</div>
        <div>Restriction</div><div id="Restriction">—</div>
        <div>Nipples</div><div id="Nipples">—</div>
        <div>E-Stim</div><div id="E-Stim">—</div>
        <div>Collar</div><div id="Collar">—</div>
      </div>
    </section>
  </div>
</div>

<!-- ECC drop-in files -->
<script src="ecc-sync.js"></script>
<script src="companion-notes-render.js"></script>

<script id="timer-set-override">
(function(){
  // Protect timer elements from base set() replacing their textContent (which removes overlays).
  try{
    var _set = window.set;
    if (typeof _set === 'function'){
      window.set = function(id, val){
        if (id === 'prepTimer' || id === 'sessTimer'){
          // Skip base write; local ticker controls the overlays.
          return;
        }
        return _set.apply(this, arguments);
      };
    }
  }catch(e){}
})();
</script>
<script>
(function(){
  "use strict";
  var ROOM='main';

  function set(id,val){ var el=document.getElementById(id); if(el){ el.textContent=(val==null||val==='')?'—':val; } }
  function fmtMMSS(x){
    if(x==null) return "00:00";
    var n = Number(x);
    if(!isFinite(n)){
      var m = String(x).match(/(\d{1,2}):(\d{2})/);
      if(m){ n = (+m[1])*60 + (+m[2]); } else { n = 0; }
    }
    if(n>86400) n = Math.round(n/1000);
    if(n<0) n = 0;
    var m = (n/60)|0, s = n%60;
    return (''+m).padStart(2,'0')+':'+(''+s).padStart(2,'0');
  }
  function normKey(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,''); }

  const DISPLAY_IDS = [
    "Scenario / Clothing","Hoods","Gags","Extras","Anal","Fucking Machine",
    "Location","Position","Vibrating Wand","Audio","Restriction","Nipples","E-Stim","Collar"
  ];
  const PICK_ALIASES = {
    "Scenario / Clothing": ["scenario/clothing","scenario / clothing","scenario","clothing"],
    "Vibrating Wand": ["vibratingwand","wand","vibe","vibrator"],
    "E-Stim": ["e-stim","estim","e‑stim","e—stim","electrostim","electro","electroplay"],
    "Fucking Machine": ["fuckingmachine","fmachine","f-machine","machine","sexmachine","thrust","thrusting","thrustingmachine","autothrust","auto-thrust","autothrustingmachine","automatictmachine","fm"]
  };

  function smartString(v){
    if(v==null) return "";
    if(typeof v==="object"){
      if(Array.isArray(v)) return v.map(smartString).filter(Boolean).join(", ");
      return Object.values(v).map(smartString).filter(Boolean).join(", ");
    }
    if(v===true) return "Yes";
    if(v===false) return "No";
    return String(v).trim();
  }

  function mapPickValue(picks, displayId){
    if(!picks) return "";
    const want = normKey(displayId);
    // 1) exact property
    if (picks[displayId] != null) return smartString(picks[displayId]);
    const aliases = (PICK_ALIASES[displayId] || []).map(normKey);
    const keys = Object.keys(picks);
    // 2) exact normalized key match
    for (const k of keys){
      const nk = normKey(k);
      if (nk === want || aliases.includes(nk)){ return smartString(picks[k]); }
    }
    // 3) substring match
    for (const k of keys){
      const nk = normKey(k);
      if (nk.includes(want) || aliases.some(a => nk.includes(a))){ return smartString(picks[k]); }
    }
    return "";
  }

  async function get(){ const r=await fetch('/.netlify/functions/get-state?room='+ROOM+'&x='+(Date.now()%1e7)); return r.json(); }
  async function post(st){ await fetch('/.netlify/functions/save-state',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({room:ROOM,state:st})}); }

  function pickNum(x){
    if(x==null) return null;
    if(typeof x==='number' && isFinite(x)) return x;
    const m=String(x).match(/\d{1,3}/);
    return m? +m[0] : null;
  }
  function getPath(obj, path){
    try{
      return path.split('.').reduce((o,k)=>o&&o[k], obj);
    }catch(e){ return undefined; }
  }
  function firstNonEmpty(obj, paths){
    for(const p of paths){
      const v = getPath(obj, p);
      if(v!=null && v!=="") return v;
    }
    return null;
  }

  function apply(st){
    // timers
    const t = st.timers || {};
    set('prepTimer', fmtMMSS(t.prep));
    set('sessTimer', fmtMMSS(t.session));

    // prep & session lengths (aggressive fallbacks)
    let prepM = firstNonEmpty(st, ["prepMins","prep","prepMinutes","prep_length"]);
    if(prepM==null && st.picks){
      prepM = firstNonEmpty({p: st.picks}, ["p.Prep (mins)","p.Prep length","p.Prep"]);
    }
    if(prepM==null && t.prep!=null){
      prepM = Math.round(Number(t.prep)/60000); // from current timer
    }
    prepM = pickNum(prepM);

    let sessM = firstNonEmpty(st, ["sessionMins","lengthMins","length"]);
    sessM = pickNum(sessM);

    set('prepLen', prepM!=null ? (prepM+' min') : '—');
    set('sessLen', sessM!=null ? (sessM+' min') : '—');

    // session meta
    set('difficulty', st.difficulty ?? '—');
    set('d10', st.d10 ?? '—');

    // Punishment / Reward (look in several places)
    const punish = firstNonEmpty(st, ["outcomes.punishment","Punishment","punishment"]) 
                || (st.picks && (st.picks["Punishment"] || st.picks["punishment"])) || "—";
    const reward = firstNonEmpty(st, ["outcomes.reward","Reward","reward"]) 
                || (st.picks && (st.picks["Reward"] || st.picks["reward"])) || "—";
    set('punishment', smartString(punish));
    set('reward', smartString(reward));

    // picks (fuzzy map)
    const pk = st.picks || {};
    for(const id of DISPLAY_IDS){
      const val = mapPickValue(pk, id);
      if(val) set(id, val);
    }

    const ts=document.getElementById('ts'); if(ts) ts.textContent=new Date().toLocaleTimeString();
  }

  async function refresh(){
    try{ const j=await get(); if(j&&j.state) apply(j.state); }catch(_){}
  }

  async function send(cmd){
    try{
      const j=await get();
      const st=(j&&j.state)? j.state : {};
      st.control = { cmd: cmd, seq: Date.now() };
      await post(st);
    }catch(_){}
  }

  function init(){
    document.getElementById('btnStartPrepSession')?.addEventListener('click', function(){ send('startPrepSession'); });
    document.getElementById('btnStartSession')?.addEventListener('click', function(){ send('startSession'); });
    document.getElementById('btnPause')?.addEventListener('click', function(){ send('pause'); });
    document.getElementById('btnResume')?.addEventListener('click', function(){ send('resume'); });
    document.getElementById('btnReset')?.addEventListener('click', function(){ send('reset'); });
    refresh();
    setInterval(refresh, 1200);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  })();
</script>





<script id="companion-timer-supervisor">
(function(){
  // === Timer Supervisor (stable reference approach) ===
  // Single source of truth we maintain locally; server updates are *hints*.
  var sup = {
    which: null,   // 'prep' | 'session' | null
    end: null,     // epoch ms when active phase ends
    prep: 0,       // ms remaining (prep) when not active, else derived from end
    session: 0,    // ms remaining (session) when not active, else derived from end
    lastSeq: 0,    // incrementing sequence to detect fresh control updates
    lastServerAt: 0, // ms timestamp when we last accepted server state
    tick: null
  };

  function now(){ return Date.now(); }
  function mmss(ms){ var s=Math.max(0,Math.floor(ms/1000)); var m=(s/60)|0, ss=(''+(s%60)).padStart(2,'0'); return (''+m).padStart(2,'0')+':'+ss; }

  // Apply visual
  function paint(){
    var prepEl = document.getElementById('prepTimer');
    var sessEl = document.getElementById('sessTimer');
    var msp = sup.which==='prep' && sup.end ? Math.max(0, sup.end - now()) : sup.prep;
    var mss = sup.which==='session' && sup.end ? Math.max(0, sup.end - now()) : sup.session;
    if (prepEl) {
      try { prepEl.style.setProperty('--display', '"'+mmss(msp)+'"'); } catch(_){}
      prepEl.classList.toggle('active', sup.which==='prep' && !!sup.end);
    }
    if (sessEl) {
      try { sessEl.style.setProperty('--display', '"'+mmss(mss)+'"'); } catch(_){}
      sessEl.classList.toggle('active', sup.which==='session' && !!sup.end);
    }
  }

  // Robust ticking independent of server cadence
  function start(){
    if (sup.tick) clearInterval(sup.tick);
    sup.tick = setInterval(paint, 250);
    paint();
  }

  // Guard against stale/zeroing updates:
  // Only accept server timer changes that (a) increase seq or (b) clearly set a new 'which' or (c) extend end into the future.
  function considerServerState(st){
    var t = (st && st.timers) || {};
    var seq = (st && st.control && st.control.seq) ? Number(st.control.seq) : 0;
    var candidate = {
      which: t.which || null,
      end: (t.end && isFinite(t.end)) ? Number(t.end) : null,
      prep: (t.prep && isFinite(t.prep)) ? Number(t.prep) : 0,
      session: (t.session && isFinite(t.session)) ? Number(t.session) : 0
    };

    // Decide if we accept this update
    var accept = false;

    // Case A: explicit control sequence bump
    if (seq && seq > sup.lastSeq) { accept = true; }

    // Case B: server indicates an active phase with a future end
    if (!accept && candidate.which && candidate.end && candidate.end > now()) { accept = true; }

    // Case C: server indicates paused (no end) but changed remaining values significantly (>500ms)
    function diff(a,b){ return Math.abs(Number(a||0)-Number(b||0)); }
    if (!accept && !candidate.end && ( diff(candidate.prep, sup.prep) > 500 || diff(candidate.session, sup.session) > 500 )) {
      accept = true;
    }

    // Case D: server is clearly resetting (both zero); only accept if we were also idle
    if (!accept && !candidate.which && !candidate.end && candidate.prep===0 && candidate.session===0) {
      if (!sup.which && sup.prep===0 && sup.session===0) accept = true; // both idle -> accept idle
      else accept = false; // ignore spurious zeroing mid-run
    }

    if (!accept) return false;

    // Accept update — normalise
    sup.which = candidate.which;
    sup.end = candidate.end;
    sup.prep = candidate.prep;
    sup.session = candidate.session;
    sup.lastSeq = Math.max(sup.lastSeq, seq||0);
    sup.lastServerAt = now();
    // Ensure repaint after accept
    paint();
    return true;
  }

  // Patch into existing refresh/apply flow
  // We wrap window.apply so we can observe the server state without breaking UI.
  try {
    var _apply = window.apply;
    if (typeof _apply === 'function'){
      window.apply = function(st){
        try { considerServerState(st||{}); } catch(e){}
        return _apply.apply(this, arguments);
      };
    }
  } catch(e){}

  // Visibility resume: when tab regains focus, repaint immediately
  try {
    document.addEventListener('visibilitychange', function(){
      if (document.visibilityState === 'visible') { paint(); }
    });
  } catch(_){}

  // Kick off supervisor ticker
  start();

  // Expose for debugging (optional)
  window.__ECC_SUP = sup;
})();
</script>
