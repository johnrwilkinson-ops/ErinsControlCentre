<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Companion</title>
<meta name="theme-color" content="#0e1428">
<style>
:root{ --bg:#0b1020; --panel:#0f1428; --line:#222844; --text:#e9ecf4; --muted:#aab1bf; --accent:#7aa2f7; }
*{ box-sizing:border-box }
html,body{ height:100% }
body{ margin:0; background:#0b1020; color:var(--text); font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Arial; }
header{ position:sticky; top:0; z-index:20; padding:12px 16px; border-bottom:1px solid var(--line); background:#0e1428; display:flex; gap:12px; align-items:center; flex-wrap:wrap }
h1{ margin:0; font-size:18px }
.badge{ font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid #2b355f; background:#172046 }
.wrap{ max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:16px }
.grid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px }
.card{ background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:12px }
.kv{ display:grid; grid-template-columns: 200px 1fr; gap:8px; align-items:start }
.kv div:nth-child(odd){ color:var(--muted) }
.kv div:nth-child(even){ font-weight:600 }
h2{ font-size:16px; margin:0 0 8px }
small{ color:var(--muted) }
@media (max-width: 800px){ .grid{ grid-template-columns: 1fr } .kv{ grid-template-columns: 140px 1fr } }
.alert{ display:none; background:#3a1c25; color:#ffd7dc; border:1px solid #6d2a38; padding:10px 12px; border-radius:12px }
.note{ background:#172046; border:1px solid #2b355f; padding:8px 10px; border-radius:10px; color:#c8d1ff }
</style>
</head>
<body>
<header>
  <h1>Companion</h1>
  <span class="badge">Room: <span id="room">main</span></span>
  <span class="badge">Mode: <span id="mode">Live</span></span>
  <span class="badge">Last update: <span id="ts">—</span></span>
</header>

<div class="wrap">
  <div id="err" class="alert"></div>
  <div id="hint" class="note" style="display:none"></div>

  <div class="grid">
    <section class="card">
      <h2>Session</h2>
      <div class="kv">
        <div>Length</div><div id="lengthLabel">—</div>
        <div>Length (mins)</div><div id="lengthMins">—</div>
        <div>Difficulty</div><div id="difficulty">—</div>
        <div>d10 (X)</div><div id="d10">—</div>
        <div>Notes</div><div id="notes">—</div>
      </div>
    </section>

    <section class="card">
      <h2>Timers</h2>
      <div class="kv">
        <div>Prep</div><div id="prepTimer">00:00</div>
        <div>Session</div><div id="sessTimer">00:00</div>
        <div>Status</div><div id="which">—</div>
      </div>
      <small>Auto-refreshes in live mode.</small>
    </section>

    <section class="card">
      <h2>Builder Picks</h2>
      <div class="kv">
        <div>Scenario / Clothing</div><div id="scenario">—</div>
        <div>Hoods</div><div id="hoods">—</div>
        <div>Gags</div><div id="gags">—</div>
        <div>Extras</div><div id="extras">—</div>
        <div>Anal</div><div id="anal">—</div>
        <div>Fucking Machine</div><div id="fm">—</div>
        <div>Location</div><div id="location">—</div>
        <div>Position</div><div id="position">—</div>
        <div>Vibrating Wand</div><div id="wand">—</div>
        <div>Audio</div><div id="audio">—</div>
        <div>Restriction</div><div id="restriction">—</div>
        <div>Nipples</div><div id="nipples">—</div>
        <div>E-Stim</div><div id="estim">—</div>
        <div>Collar</div><div id="collar">—</div>
      </div>
    </section>

    <section class="card">
      <h2>Outcomes</h2>
      <div class="kv">
        <div>Punishment</div><div id="punishment">—</div>
        <div>Reward</div><div id="reward">—</div>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  function showErr(msg){
    var box = document.getElementById('err');
    box.style.display = 'block';
    box.textContent = msg;
    console.error(msg);
  }
  function showHint(msg){
    var n = document.getElementById('hint');
    n.style.display = 'block';
    n.textContent = msg;
  }
  function set(id, val){
    var el = document.getElementById(id);
    if(el) el.textContent = (val==null||val==='') ? '—' : val;
  }
  function fmt(ms){
    var s = Math.max(0, (ms||0)/1000|0), m = s/60|0;
    return (''+m).padStart(2,'0') + ':' + (''+(s%60)).padStart(2,'0');
  }
  function applyState(state){
    try{
      set('lengthLabel', state.lengthLabel);
      set('lengthMins', state.lengthMins);
      set('difficulty', state.difficulty);
      set('d10', state.d10);
      set('notes', (state.notes||[]).join(' • '));
      var p = state.picks || {};
      ['scenario','hoods','gags','extras','anal','fm','location','position','wand','audio','restriction','nipples','estim','collar','punishment','reward']
        .forEach(function(k){ set(k, p[k]); });
      var t = state.timers || {};
      set('prepTimer', fmt(t.prep));
      set('sessTimer', fmt(t.session));
      set('which', t.which || '—');
    }catch(e){ showErr('Render error: '+e); }
  }

  function live(room){
    document.getElementById('mode').textContent = 'Live';
    var url = '/.netlify/functions/get-state?room=' + encodeURIComponent(room||'main');
    return fetch(url).then(function(r){
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }).then(function(data){
      if(data && data.state){ applyState(data.state); }
      document.getElementById('ts').textContent = new Date().toLocaleTimeString();
    }).catch(function(e){
      showHint('Live mode requires hosting with Netlify so this page can call /.netlify/functions/get-state. '
        + 'If you are viewing this file locally, use a Snapshot link from the Control Centre.');
      showErr('Live fetch failed: '+e.message);
    });
  }

  function decodeSnap(str){
    // base64url -> base64
    var s = str.replace(/-/g,'+').replace(/_/g,'/');
    // pad
    while (s.length % 4) s += '=';
    try{
      var json = atob(s);
      return JSON.parse(decodeURIComponent(escape(json)));
    }catch(e){
      // try plain base64 (non-unicode)
      try{ return JSON.parse(atob(s)); }catch(e2){ throw e2; }
    }
  }

  function snapshotMode(snap){
    document.getElementById('mode').textContent = 'Snapshot';
    try{
      var obj = decodeSnap(snap);
      if(obj && obj.state){ applyState(obj.state); }
      else showErr('Snapshot missing state payload.');
      document.getElementById('ts').textContent = new Date().toLocaleTimeString();
    }catch(e){
      showErr('Snapshot decode failed.');
    }
  }

  function init(){
    var qs = new URLSearchParams(location.search);
    var room = qs.get('room') || 'main';
    document.getElementById('room').textContent = room;

    var m = (location.hash||'').match(/#state=([^&]+)/);
    if(m){
      snapshotMode(m[1]);
    } else {
      live(room);
      setInterval(function(){ live(room); }, 1500);
    }
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
</body>
</html>
